---
title: "Descriptive_Trend_Analysis"
author: "Sevastian Sanchez"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load data 
```{r}
source("~/Documents/GitHub/QMSS_Thesis_Sanchez/df_years_function.R")
merged <- df_years(yr1 = 2000) 
```


#Option 1:Max-min scale trend function 
```{r}
library(tidyr)
library(ggplot2)
library(scales)

# Define the function
plot_trends <- function(data, country_name, start_year = 2015, end_year = 2025) {
  
  # Filter and prepare data for the specified country and time range
  country_data <- data %>%
    filter(country_name.x == country_name & year >= start_year & year <= end_year) %>%
    select(
      year,
      p1_use, p2_services, p3_products, p4_sources, p5_infra,  
      sdg_overall, lib_dem
    ) %>%
    mutate(across(-year, ~ rescale(.x)))  # Normalize all variables to 0-1 scale
  
  # Reshape data into long format for plotting
  country_long <- country_data %>%
    pivot_longer(
      cols = -year,
      names_to = "metric",
      values_to = "value"
    )
  
  # Define custom color scheme
  custom_colors <- c(
    "p1_use" = "#c6dbef",      # Light Blue
    "p2_services" = "#6baed6", # Medium Blue
    "p3_products" = "#2171b5", # Dark Blue
    "p4_sources" = "#08306b",  # Navy Blue
    "p5_infra" = "#08519c",    # Teal Blue
    "sdg_overall" = "#fc8d59", # Orange
    "lib_dem" = "#31a354"      # Green
  )
  
  metric_labels <- c(
    "p1_use" = "SPI: Data Use",
    "p2_services" = "SPI: Services",
    "p3_products" = "SPI: Products",
    "p4_sources" = "SPI: Sources",
    "p5_infra" = "SPI: Infrastructure",
    "sdg_overall" = "SDG Overall",
    "lib_dem" = "Liberal Democracy"
  )
  
  # Create the plot
  plot <- ggplot(country_long, aes(x = year, y = value, color = metric)) +
    geom_line(linewidth = 1.2) +
    geom_vline(xintercept = 2018, linetype = "dashed", color = "red") +  
    scale_color_manual(values = custom_colors, labels = metric_labels) +
    scale_y_continuous(labels = percent_format()) +  
    labs(
      title = paste(country_name, ": SPI Pillars, SDG Score, and Democracy Trends (", start_year, "-", end_year, ")", sep = ""),
      x = "Year",
      y = "Normalized Score (0-1)",
      color = "Metric",
      caption = paste("SPI data from WB Statistical Performance Index | Democracy data from V-Dem | SDG data from UN")
    ) +
    theme_minimal() +
    theme(
      legend.position = "bottom",
      legend.text = element_text(size = 8)
    )
  
  return(plot)
}

#Example: Brazil 
#plot_trends(merged_inc, country_name = "Brazil", start_year = 2000, end_year = 2020)
plot_trends(merged_inc, "Spain", 2015)
```

#Option 2:z-score standardization trend function 
```{r}
library(tidyr)
library(ggplot2)

plot_trend_z <- function(data, country_name, start_year = 2015, end_year = 2025) {
  
  # Filter and standardize data using z-scores
  country_data <- data %>%
    filter(country_name.x == country_name & year >= start_year & year <= end_year) %>%
    select(
      year,
      p1_use, p2_services, p3_products, p4_sources, p5_infra,  
      sdg_overall, lib_dem, 
    ) %>%
    # Z-score standardization (mean=0, SD=1)
    mutate(across(-year, ~ as.numeric(scale(.x))))  
  
  # Reshape data into long format
  country_long <- country_data %>%
    pivot_longer(cols = -year, names_to = "metric", values_to = "value")
  
  # Custom color scheme (same as before)
  custom_colors <- c(
    "p1_use" = "#c6dbef", "p2_services" = "#6baed6", "p3_products" = "#2171b5",
    "p4_sources" = "#08306b", "p5_infra" = "#08519c", 
    "sdg_overall" = "#fc8d59", "lib_dem" = "#31a354"
  )
  
  metric_labels <- c(
    "p1_use" = "SPI: Data Use", "p2_services" = "SPI: Services",
    "p3_products" = "SPI: Products", "p4_sources" = "SPI: Sources",
    "p5_infra" = "SPI: Infrastructure", 
    "sdg_overall" = "SDG Overall", "lib_dem" = "Liberal Democracy"
  )
  
  # Plot
  ggplot(country_long, aes(x = year, y = value, color = metric)) +
    geom_line(linewidth = 1.2) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +  # Reference line
    geom_vline(xintercept = 2020, linetype = "dashed", color = "red") +
    scale_color_manual(values = custom_colors, labels = metric_labels) +
    labs(
      title = paste0(country_name, ": SPI Pillars, SDG, and Democracy Trends (Z-Scores)"),
      x = "Year",
      y = "Z-Score (Mean = 0, SD = 1)",
      color = "Metric",
      caption = "Z-scores computed within each metric's time series"
    ) +
    theme_minimal() +
    theme(legend.position = "bottom")
}

#example: Brazil
brazil_plot <- plot_trend_z(merged_inc, "Brazil")
poland_plot <- plot_trend_z(merged_inc, "Poland")

```

