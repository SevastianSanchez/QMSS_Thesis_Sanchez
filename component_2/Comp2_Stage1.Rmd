---
title: "Component 2, Stage 1: DI -> SPI"
author: "Sevastian Sanchez"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  word_document: default
  html_document: default
---
```{r}
knitr::opts_chunk$set(
  tidy = TRUE,
  tidy.opts = list(width.cutoff = 60) 
)
```

# Set up
```{r}
# set working directory
setwd("~/Documents/GitHub/QMSS_Thesis_Sanchez")

#load libraries/packages
source("packages.R")

# load data
source("Comp2_panel_wrangling.R")
# select path = "data/Main CSV Outputs/merged_cleaned_sdg.csv"

panel_data_spi <- panel_data %>% 
  dplyr::select(country_name, country_code, year, spi_comp, di_score, di_score_lag1, di_score_lag2, log_gdppc, spi_comp_lag1, spi_comp_lag2, income_level_recoded) %>%
  dplyr::arrange(country_code, year)

# how many countries 
length(unique(panel_data_comp1_data$country_code)) 

# check that lag structure is correct 
head(panel_data_spi[, c("country_code", "year", "spi_comp", "spi_comp_lag1", "spi_comp_lag2",  "di_score", "di_score_lag1", "di_score_lag2")])

# check dimensions
dim(panel_data_spi) 

# testing dataframes for sensitivity of results 
panel_data <- panel_data_spi
```
*sensitivity analysis*
Basing analysis of dataset sensitivity on FE model of the second order (fe_spi_di_L2)

- Dataset = panel_data_comp1_data, 1336 obs, 167 countries, FE models (di_score_lag2) showed p = 0.07598 (marginally significant)

- Dataset = panel_data_sdg,  1336 obs, 167 countries, FE models (di_score_lag2) showed p = 0.07598 (marginally significant)

- Dataset = panel_data_exclusive, 1296 obs, 162 countries, FE models (di_score_lag2) showed p = 0.079 (marginally significant)

- Dataset = panel_data_spi, 1392 obs, 174 countries, FE models (di_score_lag2) showed p = 0.1497 (not significant)

# Stage 1 Models:
ols_spi_di
ols_spi_di_L1
ols_spi_di_L2

fd_spi_di
fd_spi_di_L1
fd_spi_di_L2

fe_spi_di
fe_spi_di_L1
fe_spi_di_L2

# 1.1) POLS [Stage 1]: SPI ~ DI
The effect of democracy on SPI Performance
```{r}
# Contemporaneous Effect: SPI ~ DI
ols_spi_di <- plm(
  formula = spi_comp ~ di_score + log_gdppc + factor(income_level_recoded) + factor(year), 
  index = c("country_code", "year"),
  model = "pooling", 
  data = panel_data)
summary(ols_spi_di, vcov = vcovHC(ols_spi_di, cluster = "group", type = "HC1"))

# Adding Lag1: SPI ~ DI
ols_spi_di_L1 <- plm(
  formula = spi_comp ~ di_score + di_score_lag1 + log_gdppc + factor(income_level_recoded) + factor(year), 
  index = c("country_code", "year"),
  model = "pooling", 
  data = panel_data)
summary(ols_spi_di_L1, vcov = vcovHC(ols_spi_di_L1, cluster = "group", type = "HC1"))

# Adding Lag2: SPI ~ DI
ols_spi_di_L2 <- plm(
  formula = spi_comp ~ di_score + di_score_lag1 + di_score_lag2 + log_gdppc + factor(income_level_recoded) + factor(year), 
  index = c("country_code", "year"),
  model = "pooling", 
  data = panel_data)
summary(ols_spi_di_L2, vcov = vcovHC(ols_spi_di_L2, cluster = "group", type = "HC1"))
```

## POLS Summary Table
```{r eval=FALSE, include=FALSE}
# --- POLS MODELS TABLE ---

# Extracting robust standard errors for the two POLS models
rob_se_pols <- list(
  coeftest(ols_spi_di, vcov = vcovHC(ols_spi_di, cluster = "group", type = "HC1"))[, 2],
  coeftest(ols_spi_di_L1, vcov = vcovHC(ols_spi_di_L1, cluster = "group", type = "HC1"))[, 2],
  coeftest(ols_spi_di_L2, vcov = vcovHC(ols_spi_di_L2, cluster = "group", type = "HC1"))[, 2]
)

# Generate the stargazer table for POLS models
stargazer(
  ols_spi_di, ols_spi_di_L1, ols_spi_di_L2,
  se = rob_se_pols,
  type = "html",
  out = "figures/s1_pols_lags.html",
  title = "Stage I Models: Pooled OLS (Current and Lagged Effects)",
  align = TRUE,
  dep.var.labels = "SPI Overall Score",
  column.labels = c("Contemporaneous", "Lag 1", "Lag 2"),
  covariate.labels = c("DI Composite", "Lagged DI (t-1)", "Lagged DI (t-2)",  "Log(GDPper-capita)", "Lower-Middle Income (LMIC)", "Upper-Middle Income (UMIC)", "High Income (HIC)", "Intercept"),
  report = "vcs*",
  notes = "Robust standard errors clustered by country in parentheses",
  omit = "factor\\(year\\)",
  model.names = FALSE
)
```

# 1.2) First Difference [Stage 1]: SPI ~ DI
```{r}
# Contemporaneous Effect: SPI ~ DI
fd_spi_di <- plm(
  formula = spi_comp ~ di_score + log_gdppc +  factor(income_level_recoded),
  index = c("country_code", "year"),
  data = fd_data, 
  model = "fd"
)
summary(fd_spi_di, vcov = vcovHC(fd_spi_di, cluster = "group", type = "HC1"))

# Adding Lag1: SPI ~ DI
fd_spi_di_L1 <- plm(
  formula = spi_comp ~ di_score + di_score_lag1 + log_gdppc + factor(income_level_recoded),
  index = c("country_code", "year"),
  data = fd_data, 
  model = "fd"
)
summary(fd_spi_di_L1, vcov = vcovHC(fd_spi_di_L1, cluster = "group", type = "HC1"))

# Adding Lag2: SPI ~ DI
fd_spi_di_L2 <- plm(
  formula = spi_comp ~ di_score + di_score_lag1 + di_score_lag2 + log_gdppc + factor(income_level_recoded),
  index = c("country_code", "year"),
  data = fd_data, 
  model = "fd"
)
summary(fd_spi_di_L2, vcov = vcovHC(fd_spi_di_L2, cluster = "group", type = "HC1"))
```

## First Difference Summary Table
```{r eval=FALSE, include=FALSE}
# --- FD MODELS TABLE ---
# extracting robust standard errors for the three FD models
rob_se_fd <- list(
  coeftest(fd_spi_di, vcov = vcovHC(fd_spi_di, cluster = "group", type = "HC1"))[, 2],
  coeftest(fd_spi_di_L1, vcov = vcovHC(fd_spi_di_L1, cluster = "group", type = "HC1"))[, 2],
  coeftest(fd_spi_di_L2, vcov = vcovHC(fd_spi_di_L2, cluster = "group", type = "HC1"))[, 2]
)
# stargazer table for FD models
stargazer(
  fd_spi_di, fd_spi_di_L1, fd_spi_di_L2,
  se = rob_se_fd,
  type = "html",
  out = "figures/s1_fd_lags.html",
  title = "Stage I Models: First Difference (Current and Lagged Effects)",
  align = TRUE,
  dep.var.labels = "SPI Overall Score",
  column.labels = c("Contemporaneous", "Lag 1", "Lag 2"),
  covariate.labels = c("DI Composite", "Lagged DI (t-1)", "Lagged DI (t-2)",  "Log(GDPper-capita)", "Lower-Middle Income (LMIC)", "Upper-Middle Income (UMIC)", "High Income (HIC)", "Intercept"),
  report = "vcs*",
  notes = "Robust standard errors clustered by country in parentheses",
  omit = "factor\\(year\\)",
  model.names = FALSE
)
```

# 1.3) Fixed Effects [Stage 1]: SPI ~ DI
```{r}
# Contemporaneous Effect: SPI ~ DI 
fe_spi_di <- plm(
  formula = spi_comp ~ di_score + log_gdppc + factor(income_level_recoded) + factor(year),
  index = c("country_code", "year"),
  data = panel_data,
  model = "within")
summary(fe_spi_di, vcov = vcovHC(fe_spi_di, cluster = "group", type = "HC1"))

# Adding Lag1: SPI ~ DI
fe_spi_di_L1 <- plm(
  formula = spi_comp ~ di_score + di_score_lag1 + log_gdppc + factor(income_level_recoded) + factor(year),
  index = c("country_code", "year"),
  data = panel_data,
  model = "within")
summary(fe_spi_di_L1, vcov = vcovHC(fe_spi_di_L1, cluster = "group", type = "HC1"))

# Adding Lag2: SPI ~ DI
fe_spi_di_L2 <- plm(
  formula = spi_comp ~ di_score + di_score_lag1 + di_score_lag2 + log_gdppc + factor(income_level_recoded) + factor(year),
  index = c("country_code", "year"),
  data = panel_data,
  model = "within")
summary(fe_spi_di_L2, vcov = vcovHC(fe_spi_di_L2, cluster = "group", type = "HC1"))

```

## Fixed Effects Summary Table
```{r eval=FALSE, include=FALSE}
# --- FE MODELS TABLE ---
# Extracting robust standard errors for the three FE models
rob_se_fe <- list(
  coeftest(fe_spi_di, vcov = vcovHC(fe_spi_di, cluster = "group", type = "HC1"))[, 2],
  coeftest(fe_spi_di_L1, vcov = vcovHC(fe_spi_di_L1, cluster = "group", type = "HC1"))[, 2],
  coeftest(fe_spi_di_L2, vcov = vcovHC(fe_spi_di_L2, cluster = "group", type = "HC1"))[, 2]
)
# stargazer table for FE models
stargazer(
  fe_spi_di, fe_spi_di_L1, fe_spi_di_L2,
  se = rob_se_fe,
  type = "html",
  out = "figures/s1_fe_lags.html",
  title = "Stage I Models: Fixed Effects (Current and Lagged Effects)",
  align = TRUE,
  dep.var.labels = "SPI Overall Score",
  column.labels = c("Contemporaneous", "Lag 1", "Lag 2"),
  covariate.labels = c("DI Composite", "Lagged DI (t-1)", "Lagged DI (t-2)",  "Log(GDPper-capita)", "Lower-Middle Income (LMIC)", "Upper-Middle Income (UMIC)", "High Income (HIC)", "Intercept"),
  report = "vcs*",
  notes = "Robust standard errors clustered by country in parentheses",
  omit = "factor\\(year\\)",
  model.names = FALSE
)
```

### stargazer table for only lag2 models
```{r eval=FALSE, include=FALSE}
# stargazer table for only lag2 models
stargazer(
  ols_spi_di_L2, fd_spi_di_L2, fe_spi_di_L2,
  se = list(
    coeftest(ols_spi_di_L2, vcov = vcovHC(ols_spi_di_L2, cluster = "group", type = "HC1"))[, 2],
    coeftest(fd_spi_di_L2, vcov = vcovHC(fd_spi_di_L2, cluster = "group", type = "HC1"))[, 2],
    coeftest(fe_spi_di_L2, vcov = vcovHC(fe_spi_di_L2, cluster = "group", type = "HC1"))[, 2]
  ),
  type = "html",
  title = "Stage I Models: Lagged Effects (Lag 2)",
  align = TRUE,
  dep.var.labels = "SPI Overall Score",
  column.labels = c("POLS", "FD", "FE"),
  covariate.labels = c("DI Composite", "Lagged DI (t-1)", "Lagged DI (t-2)",  "Log(GDPper-capita)", "Lower-Middle Income (LMIC)", "Upper-Middle Income (UMIC)", "High Income (HIC)", "Intercept"),
  report = "vcs*",
  notes = "Robust standard errors clustered by country in parentheses",
  omit = "factor\\(year\\)",
  model.names = FALSE,
  out = "figures/s1_lag2_mods.html"
)

```

## Fixed Effects Error Bar Visualization 
```{r}
# Extract coefficients and robust standard errors from the FE model
fe_spi_di_L2_results <- summary(fe_spi_di_L2, vcov = vcovHC(fe_spi_di_L2, cluster = "group", type = "HC1"))
# Create a data frame for visualization
coef_df <- data.frame(
  term = rownames(fe_spi_di_L2_results$coefficients),
  estimate = fe_spi_di_L2_results$coefficients[, "Estimate"],
  std.error = fe_spi_di_L2_results$coefficients[, "Std. Error"]
)
# Create a ggplot error bar chart
ggplot(coef_df, aes(x = term, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), width = 0.2) +
  labs(title = "Lagged Effects in FE Model (SPI ~ DI)", x = "Terms", y = "Coefficient Estimate") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Save the plot
#ggsave("figures/error_bar_fe_spi_di_L2.png", width = 10, height = 6)

```

## First Difference Error Bar Visualization 
```{r}
# Extract coefficients and robust standard errors from the FD model
fd_spi_di_L2_results <- summary(fd_spi_di_L2, vcov = vcovHC(fd_spi_di_L2, cluster = "group", type = "HC1"))
# Create a data frame for visualization
coef_fd_df <- data.frame(
  term = rownames(fd_spi_di_L2_results$coefficients),
  estimate = fd_spi_di_L2_results$coefficients[, "Estimate"],
  std.error = fd_spi_di_L2_results$coefficients[, "Std. Error"]
)
# Create a ggplot error bar chart
ggplot(coef_fd_df, aes(x = term, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), width = 0.2) +
  labs(title = "Lagged Effects in FD Model (SPI ~ DI)", x = "Terms", y = "Coefficient Estimate") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# Save the plot

#ggsave("figures/error_bar_fd_spi_di_L2", width = 10, height = 6)

```

## Check for Autocorrelation 
```{r}
# APPLY Wooldridge Test for AR(1) Errors in FE Panel Models: pwartest()
# https://search.r-project.org/CRAN/refmans/plm/html/pwartest.html  
# This is MUCH BETTER for panel data with small T AND unbalanced panels!!!
pwartest(fe_spi_di_L2) # [significant]
```
Significant p-value indicates the presence of autocorrelation in the residuals of the fixed effects model. This suggests that the errors are correlated over time, which violates one of the key assumptions of linear regression models.

This is corrected by using robust standard errors clustered by country, which accounts for the potential autocorrelation in the residuals.

## Check for Heteroskedasticity
```{r}
# Apply Breusch-Pagan test for heteroskedasticity
bptest(fe_spi_di_L2, studentize = TRUE) # Heteroskedasticity [significant]
bptest(fd_spi_di_L2, studentize = TRUE) # Heteroskedasticity [significant]
```
The Breusch-Pagan test indicates the presence of heteroskedasticity in the residuals of the fixed effects model. This suggests that the variance of the errors is not constant across observations, which violates another key assumption of linear regression models.


