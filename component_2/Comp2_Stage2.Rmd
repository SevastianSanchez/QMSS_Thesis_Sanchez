---
title: "Component 2, Stage 2"
author: "Sevastian Sanchez"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: no
    toc_depth: '3'
    number_sections: yes
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
    number_sections: yes
    highlight: tango
    theme: default
    fig_caption: yes
    df_print: tibble
  word_document: default
  urlcolor: blue
---
```{r}
knitr::opts_chunk$set(
  echo = TRUE, warning = FALSE, message = FALSE,
  tidy = TRUE, tidy.opts = list(width.cutoff = 60) 
)
```

# Set up
```{r}
# set working directory
setwd("~/Documents/GitHub/QMSS_Thesis_Sanchez")

#load libraries/packages
source("packages.R")

# load data
source("Comp2_panel_wrangling.R")
# select path = "data/Main CSV Outputs/merged_cleaned_sdg.csv"

# select relevant variables and arrange data
panel_data <- panel_data %>% 
  dplyr::select(country_name, country_code, year, sdg_overall, spi_comp, di_score, di_score_lag1, di_score_lag2, log_gdppc, spi_comp_lag1, spi_comp_lag2, income_level_recoded) %>%
  dplyr::arrange(country_code, year)

# how many countries 
length(unique(panel_data$country_code)) 

# check lag structure is correct 
head(panel_data[, c("country_code", "year", "sdg_overall", "spi_comp", "spi_comp_lag1", "spi_comp_lag2",  "di_score", "di_score_lag1", "di_score_lag2")])

# check dimensions 
dim(panel_data) 
```

# 2.1) POLS SDG ~ SPI [Stage 2]
```{r}
# Contemporaneous Effect: SDG ~ SPI + DI
ols_sdg_spi <- plm(formula = sdg_overall ~ spi_comp + di_score + log_gdppc + factor(income_level_recoded) + factor(year), 
               model = "pooling", 
               index = c("country_code", "year"),
               data = panel_data)
summary(ols_sdg_spi, vcov = vcovHC(ols_sdg_spi, cluster = "group", type = "HC1"))

# Adding Lag1: SPI ~ DI
ols_sdg_spi_L1 <- plm(formula = sdg_overall ~ spi_comp + spi_comp_lag1 + di_score + di_score_lag1 + log_gdppc + factor(income_level_recoded) + factor(year), 
               model = "pooling", 
               index = c("country_code", "year"),
               data = panel_data)
summary(ols_sdg_spi_L1, vcov = vcovHC(ols_sdg_spi_L1, cluster = "group", type = "HC1"))

# Adding Lag2: SPI ~ DI
ols_sdg_spi_L2 <- plm(formula = sdg_overall ~ spi_comp + spi_comp_lag1 + spi_comp_lag2 + di_score + di_score_lag1 + di_score_lag2 + log_gdppc + factor(income_level_recoded) + factor(year), 
               model = "pooling", 
               index = c("country_code", "year"),
               data = panel_data)
summary(ols_sdg_spi_L2, vcov = vcovHC(ols_sdg_spi_L2, cluster = "group", type = "HC1"))
```

## Stargazer Table for POLS Models
```{r eval=FALSE, include=FALSE}
# --- POLS MODELS TABLE ---
# Extracting robust standard errors for the three POLS models
rob_se_pols <- list(
  sqrt(diag(vcovHC(ols_sdg_spi, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(ols_sdg_spi_L1, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(ols_sdg_spi_L2, cluster = "group", type = "HC1")))
)
# Generate the stargazer table for POLS models
stargazer(ols_sdg_spi, ols_sdg_spi_L1, ols_sdg_spi_L2, 
          se = rob_se_pols,
          title = "Stage 2 Models: SDG ~ SPI",
          align = TRUE,
          dep.var.labels = "SDG Overall Score",
          column.labels = c("Contemporaneous", "Lag 1", "Lag 2"),
          covariate.labels = c("SPI Composite", "Lagged SPI (t-1)", "Lagged SPI (t-2)", "DI Composite", "Lagged DI (t-1)", "Lagged DI (t-2)",  "Log(GDPper-capita)", "Lower-Middle Income (LMIC)", "Upper-Middle Income (UMIC)", "High Income (HIC)", "Intercept"),
          notes = "Robust standard errors clustered by country in parentheses",
          type = "html", 
          report = "vcs*", 
          model.numbers = FALSE,
          #keep.stat = c("n", "rsq", "adj.rsq"),
          omit = "factor\\(year\\)",  # Omits year FE from display
          out = "component_2/figures/stage2/s2_pols_lags.html") 

```

# 2.2) First Difference [Stage 2]
```{r}
# Contemporaneous Effect: SDG ~ SPI + DI
fd_sdg_spi <- plm(formula = sdg_overall ~ spi_comp + di_score + log_gdppc + factor(income_level_recoded), 
               model = "fd", 
               index = c("country_code", "year"),
               data = fd_data)
summary(fd_sdg_spi, vcov = vcovHC(fd_sdg_spi, cluster = "group", type = "HC1"))

# Adding Lag1: SPI ~ DI
fd_sdg_spi_L1 <- plm(formula = sdg_overall ~ spi_comp + spi_comp_lag1 + di_score + di_score_lag1 + log_gdppc + factor(income_level_recoded), 
               model = "fd", 
               index = c("country_code", "year"),
               data = fd_data)
summary(fd_sdg_spi_L1, vcov = vcovHC(fd_sdg_spi_L1, cluster = "group", type = "HC1"))

# Adding Lag2: SPI ~ DI
fd_sdg_spi_L2 <- plm(formula = sdg_overall ~ spi_comp + spi_comp_lag1 + spi_comp_lag2 + di_score + di_score_lag1 + di_score_lag2 + log_gdppc + factor(income_level_recoded), 
               model = "fd", 
               index = c("country_code", "year"),
               data = fd_data)
summary(fd_sdg_spi_L2, vcov = vcovHC(fd_sdg_spi_L2, cluster = "group", type = "HC1"))
```

## Stargazer Table for FD Models
```{r eval=FALSE, include=FALSE}
# Extracting robust standard errors for the three FD models
rob_se_fd <- list(
  sqrt(diag(vcovHC(fd_sdg_spi, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(fd_sdg_spi_L1, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(fd_sdg_spi_L2, cluster = "group", type = "HC1")))
)
# Generate the stargazer table for FD models
stargazer(fd_sdg_spi, fd_sdg_spi_L1, fd_sdg_spi_L2, 
          se = rob_se_fd,
          title = "Stage 2 Models: SDG ~ SPI (First Difference)",
          align = TRUE,
          dep.var.labels = "SDG Overall Score",
          column.labels = c("Contemporaneous", "Lag 1", "Lag 2"),
          covariate.labels = c("SPI Composite", "Lagged SPI (t-1)", "Lagged SPI (t-2)", "DI Composite", "Lagged DI (t-1)", "Lagged DI (t-2)",  "Log(GDPper-capita)", "Lower-Middle Income (LMIC)", "Upper-Middle Income (UMIC)", "High Income (HIC)", "Intercept"),
          notes = "Robust standard errors clustered by country in parentheses",
          type = "html", 
          report = "vcs*", 
          #keep.stat = c("n", "rsq", "adj.rsq"),
          omit = "factor\\(year\\)",  # Omits year FE from display
          out = "component_2/figures/stage2/s2_fd_lags.html")
```

# 2.3) Fixed Effects [Stage 2]
```{r}
# Contemporaneous Effect: SDG ~ SPI + DI
fe_sdg_spi <- plm(formula = sdg_overall ~ spi_comp + di_score + log_gdppc + factor(year) + factor(income_level_recoded),
  index = c("country_code", "year"),
  data = panel_data,
  model = "within" #FE
)
summary(fe_sdg_spi, vcov = vcovHC(fe_sdg_spi, cluster = "group", type = "HC1")) # Robust SEs

# Adding Lag1: SPI ~ DI
fe_sdg_spi_L1 <- plm(formula = sdg_overall ~ spi_comp + spi_comp_lag1 + di_score + di_score_lag1 + log_gdppc + factor(income_level_recoded) + factor(year), 
               model = "within", 
               index = c("country_code", "year"),
               data = panel_data)
summary(fe_sdg_spi_L1, vcov = vcovHC(fe_sdg_spi_L1, cluster = "group", type = "HC1"))

# Adding Lag2: SPI ~ DI
fe_sdg_spi_L2 <- plm(formula = sdg_overall ~ spi_comp + spi_comp_lag1 + spi_comp_lag2 + di_score + di_score_lag1 + di_score_lag2 + log_gdppc + factor(income_level_recoded) + factor(year), 
               model = "within", 
               index = c("country_code", "year"),
               data = panel_data)
summary(fe_sdg_spi_L2, vcov = vcovHC(fe_sdg_spi_L2, cluster = "group", type = "HC1"))
```

# Stargazer Table for FE Models
```{r eval=FALSE, include=FALSE}
# Extracting robust standard errors for the three FE models
rob_se_fe <- list(
  sqrt(diag(vcovHC(fe_sdg_spi, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(fe_sdg_spi_L1, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(fe_sdg_spi_L2, cluster = "group", type = "HC1")))
)
# Generate the stargazer table for FE models
stargazer(fe_sdg_spi, fe_sdg_spi_L1, fe_sdg_spi_L2, 
          se = rob_se_fe,
          title = "Stage 2 Models: SDG ~ SPI (Fixed Effects)",
          align = TRUE,
          dep.var.labels = "SDG Overall Score",
          column.labels = c("Contemporaneous", "Lag 1", "Lag 2"),
          covariate.labels = c("SPI Composite", "Lagged SPI (t-1)", "Lagged SPI (t-2)", "DI Composite", "Lagged DI (t-1)", "Lagged DI (t-2)",  "Log(GDPper-capita)", "Lower-Middle Income (LMIC)", "Upper-Middle Income (UMIC)", "High Income (HIC)", "Intercept"),
          notes = "Robust standard errors clustered by country in parentheses",
          type = "html", 
          report = "vcs*", 
          #keep.stat = c("n", "rsq", "adj.rsq"),
          omit = "factor\\(year\\)",  # Omits year FE from display
          out = "component_2/figures/stage2/s2_fe_lags.html")
```

## make a stargazer table of all Lag2 models for POLS, FD and FE
```{r eval=FALSE, include=FALSE}
# Extracting robust standard errors for the three models
rob_se_lag2 <- list(
  sqrt(diag(vcovHC(ols_sdg_spi_L2, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(fd_sdg_spi_L2, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(fe_sdg_spi_L2, cluster = "group", type = "HC1")))
)
# Generate the stargazer table for Lag2 models
stargazer(ols_sdg_spi_L2, fd_sdg_spi_L2, fe_sdg_spi_L2, 
          se = rob_se_lag2,
          title = "Stage 2 Models: SDG ~ SPI (Lag2)",
          align = TRUE,
          dep.var.labels = "SDG Overall Score",
          column.labels = c("POLS", "FD", "FE"),
          covariate.labels = c("SPI Composite", "Lagged SPI (t-1)", "Lagged SPI (t-2)", "DI Composite", "Lagged DI (t-1)", "Lagged DI (t-2)",  "Log(GDPper-capita)", "Lower-Middle Income (LMIC)", "Upper-Middle Income (UMIC)", "High Income (HIC)", "Intercept"),
          notes = "Robust standard errors clustered by country in parentheses",
          type = "html", 
          report = "vcs*", 
          #keep.stat = c("n", "rsq", "adj.rsq"),
          omit = "factor\\(year\\)",  # Omits year FE from display
          out = "component_2/figures/stage2/s2_lag2_mods.html")
```

## Fixed Effects Error Bar Visualization 
```{r}
# Extract coefficients and robust standard errors from the FE model
coefs <- summary(fe_sdg_spi_L2, vcov = vcovHC(fe_sdg_spi_L2, cluster = "group", type = "HC1"))$coefficients
# Create a data frame for visualization
coef_df <- data.frame(
  term = rownames(coefs),
  estimate = coefs[, "Estimate"],
  std.error = coefs[, "Std. Error"]
)
# Create a ggplot error bar chart
ebar_fe <- ggplot(coef_df, aes(x = term, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), width = 0.2) +
  labs(title = "Stage II: FE Model (sdg_overall ~ spi_comp + di_score)",
       x = NULL,
       y = "Coefficient Estimate") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(labels = c("di_score" = "Democracy (DI)", 
                              "di_score_lag1" = "Lagged DI (t-1)", 
                              "di_score_lag2" = "Lagged DI (t-2)", 
                              "spi_comp" = "Statistical Performance (SPI)",
                              "spi_comp_lag1" = "Lagged SPI (t-1)",
                              "spi_comp_lag2" = "Lagged SPI (t-2)",
                              "log_gdppc" = "Log(GDP per capita)", 
                              "factor(income_level_recoded)1" = "Lower-Middle Income (LMIC)", 
                              "factor(income_level_recoded)2" = "Upper-Middle Income (UMIC)", 
                              "factor(income_level_recoded)3" = "High Income (HIC)", 
                              "factor(year)2017" = "Year 2017",
                              "factor(year)2018" = "Year 2018",
                              "factor(year)2019" = "Year 2019",
                              "factor(year)2020" = "Year 2020",
                              "factor(year)2021" = "Year 2021",
                              "factor(year)2022" = "Year 2022",
                              "factor(year)2023" = "Year 2023",
                              "Intercept" = "Intercept"
                              ),
                   limits = c(
                   "di_score", 
                   "di_score_lag1",
                   "di_score_lag2",
                   "spi_comp",
                   "spi_comp_lag1",
                   "spi_comp_lag2",
                   "log_gdppc",
                   "factor(income_level_recoded)1",
                   "factor(income_level_recoded)2",
                   "factor(income_level_recoded)3",
                   "factor(year)2017",
                   "factor(year)2018",
                   "factor(year)2019",
                   "factor(year)2020",
                   "factor(year)2021",
                   "factor(year)2022",
                   "factor(year)2023",
                   "Intercept"
                 ))

ebar_fe

# Save the plot
#ggsave("component_2/figures/stage2/error_bar_fe_sdg_spi_L2.png", ebar_fe, width = 10, height = 6)
```

## First Difference Error Bar Visualization
```{r}
# Extract coefficients and robust standard errors from the FD model
coefs_fd <- summary(fd_sdg_spi_L2, vcov = vcovHC(fd_sdg_spi_L2, cluster = "group", type = "HC1"))$coefficients
# Create a data frame for visualization
coef_df_fd <- data.frame(
  term = rownames(coefs_fd),
  estimate = coefs_fd[, "Estimate"],
  std.error = coefs_fd[, "Std. Error"]
)
# Create a ggplot error bar chart for the FD model
ebar_fd <- ggplot(coef_df_fd, aes(x = term, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), width = 0.2) +
  labs(title = "Lagged Effects in FD Model (sdg_overall ~ spi_comp + di_score + log_gdppc + income_level_recoded)",
       x = NULL,
       y = "Coefficient Estimate") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_x_discrete(labels = c("di_score" = "Democracy (DI)", 
                              "di_score_lag1" = "Lagged DI (t-1)", 
                              "di_score_lag2" = "Lagged DI (t-2)", 
                              "spi_comp" = "Statistical Performance (SPI)",
                              "spi_comp_lag1" = "Lagged SPI (t-1)",
                              "spi_comp_lag2" = "Lagged SPI (t-2)",
                              "log_gdppc" = "Log(GDP per capita)", 
                              "factor(income_level_recoded)1" = "Lower-Middle Income (LMIC)", 
                              "factor(income_level_recoded)2" = "Upper-Middle Income (UMIC)", 
                              "factor(income_level_recoded)3" = "High Income (HIC)", 
                              "Intercept" = "Intercept"
                              ),
                   limits = c(
                   "di_score", 
                   "di_score_lag1",
                   "di_score_lag2",
                   "spi_comp",
                   "spi_comp_lag1",
                   "spi_comp_lag2",
                   "log_gdppc",
                   "factor(income_level_recoded)1",
                   "factor(income_level_recoded)2",
                   "factor(income_level_recoded)3",
                   "Intercept"
                 ))

ebar_fd

# Save the plot
#ggsave("component_2/figures/stage2/error_bar_fd_sdg_spi_L2.png", ebar_fd, width = 10, height = 6)
```

## Check for Autocorrelation 
```{r}
# APPLY Wooldridge Test for AR(1) Errors in FE Panel Models: pwartest()
# https://search.r-project.org/CRAN/refmans/plm/html/pwartest.html  
# This is MUCH BETTER for panel data with small T AND unbalanced panels!!!
pwartest(fe_sdg_spi_L2) # [significant]

```
Significant p-value indicates the presence of autocorrelation in the residuals of the fixed effects model. This suggests that the errors are correlated over time, which violates one of the key assumptions of linear regression models.

## Check for Heteroskedasticity
```{r}
# Apply Breusch-Pagan test for heteroskedasticity
bptest(fe_sdg_spi_L2, studentize = TRUE) # Heteroskedasticity [significant]
bptest(fd_sdg_spi_L2, studentize = TRUE) # Heteroskedasticity [significant]
```
The Breusch-Pagan test indicates the presence of heteroskedasticity in the residuals of the fixed effects model. This suggests that the variance of the errors is not constant across observations, which violates another key assumption of linear regression models.

Both violations are corrected by using robust standard errors clustered at the country level, which accounts for autocorrelation and heteroskedasticity.

