---
title: "Component 2, Stage 2: SPI -> SDG"
output: html_document
---
# Stage 2: SDG ~ SPI (Mediator) + DI 

# Set up and Wrangling 
```{r}
# set working directory
setwd("~/Documents/GitHub/QMSS_Thesis_Sanchez")

#load libraries/packages
source("packages.R")

# load data
source("Comp2_panel_wrangling.R")
# select path = "data/Main CSV Outputs/merged_cleaned_sdg.csv"

# select relevant variables and arrange data
panel_data_s2 <- panel_data %>% 
  dplyr::select(country_name, country_code, year, sdg_overall, spi_comp, di_score, di_score_lag1, di_score_lag2, log_gdppc, spi_comp_lag1, spi_comp_lag2, income_level_recoded) %>%
  dplyr::arrange(country_code, year)

# check lag structure is correct 
head(panel_data_s2[, c("country_code", "year", "sdg_overall", "spi_comp", "spi_comp_lag1", "spi_comp_lag2",  "di_score", "di_score_lag1", "di_score_lag2")])

dim(panel_data_s2) # 1336 rows, 12 columns
```

# 2.1) POLS SDG ~ SPI [Stage 2]
```{r}
# Contemporaneous Effect: SDG ~ SPI + DI
ols_sdg_spi <- plm(formula = sdg_overall ~ spi_comp + di_score + log_gdppc + factor(income_level_recoded) + factor(year), 
               model = "pooling", 
               index = c("country_code", "year"),
               data = panel_data_s2)
summary(ols_sdg_spi, vcov = vcovHC(ols_sdg_spi, cluster = "group", type = "HC1"))

# Adding Lag1: SPI ~ DI
ols_sdg_spi_L1 <- plm(formula = sdg_overall ~ spi_comp + spi_comp_lag1 + di_score + di_score_lag1 + log_gdppc + factor(income_level_recoded) + factor(year), 
               model = "pooling", 
               index = c("country_code", "year"),
               data = panel_data_s2)
summary(ols_sdg_spi_L1, vcov = vcovHC(ols_sdg_spi_L1, cluster = "group", type = "HC1"))

# Adding Lag2: SPI ~ DI
ols_sdg_spi_L2 <- plm(formula = sdg_overall ~ spi_comp + spi_comp_lag1 + spi_comp_lag2 + di_score + di_score_lag1 + di_score_lag2 + log_gdppc + factor(income_level_recoded) + factor(year), 
               model = "pooling", 
               index = c("country_code", "year"),
               data = panel_data_s2)
summary(ols_sdg_spi_L2, vcov = vcovHC(ols_sdg_spi_L2, cluster = "group", type = "HC1"))
```

## Stargazer Table for POLS Models
```{r}
# --- POLS MODELS TABLE ---
# Extracting robust standard errors for the three POLS models
rob_se_pols <- list(
  sqrt(diag(vcovHC(ols_sdg_spi, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(ols_sdg_spi_L1, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(ols_sdg_spi_L2, cluster = "group", type = "HC1")))
)
# Generate the stargazer table for POLS models
stargazer(ols_sdg_spi, ols_sdg_spi_L1, ols_sdg_spi_L2, 
          se = rob_se_pols,
          title = "Stage 2 Models: SDG ~ SPI",
          align = TRUE,
          dep.var.labels = "SDG Overall Score",
          column.labels = c("Contemporaneous", "Lag 1", "Lag 2"),
          covariate.labels = c("SPI Composite", "Lagged SPI (t-1)", "Lagged SPI (t-2)", "DI Composite", "Lagged DI (t-1)", "Lagged DI (t-2)",  "Log(GDPper-capita)", "Lower-Middle Income (LMIC)", "Upper-Middle Income (UMIC)", "High Income (HIC)", "Intercept"),
          notes = "Robust standard errors clustered by country in parentheses",
          type = "html", 
          report = "vcs*", 
          model.numbers = FALSE,
          #keep.stat = c("n", "rsq", "adj.rsq"),
          omit = "factor\\(year\\)",  # Omits year FE from display
          out = "figures/s2_pols_lags.html") 

```

# 2.2) First Difference [Stage 2]
```{r}
# Contemporaneous Effect: SDG ~ SPI + DI
fd_sdg_spi <- plm(formula = sdg_overall ~ spi_comp + di_score + log_gdppc + factor(income_level_recoded), 
               model = "fd", 
               index = c("country_code", "year"),
               data = fd_data)
summary(fd_sdg_spi, vcov = vcovHC(fd_sdg_spi, cluster = "group", type = "HC1"))

# Adding Lag1: SPI ~ DI
fd_sdg_spi_L1 <- plm(formula = sdg_overall ~ spi_comp + spi_comp_lag1 + di_score + di_score_lag1 + log_gdppc + factor(income_level_recoded), 
               model = "fd", 
               index = c("country_code", "year"),
               data = fd_data)
summary(fd_sdg_spi_L1, vcov = vcovHC(fd_sdg_spi_L1, cluster = "group", type = "HC1"))

# Adding Lag2: SPI ~ DI
fd_sdg_spi_L2 <- plm(formula = sdg_overall ~ spi_comp + spi_comp_lag1 + spi_comp_lag2 + di_score + di_score_lag1 + di_score_lag2 + log_gdppc + factor(income_level_recoded), 
               model = "fd", 
               index = c("country_code", "year"),
               data = fd_data)
summary(fd_sdg_spi_L2, vcov = vcovHC(fd_sdg_spi_L2, cluster = "group", type = "HC1"))
```

## Stargazer Table for FD Models
```{r}
# Extracting robust standard errors for the three FD models
rob_se_fd <- list(
  sqrt(diag(vcovHC(fd_sdg_spi, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(fd_sdg_spi_L1, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(fd_sdg_spi_L2, cluster = "group", type = "HC1")))
)
# Generate the stargazer table for FD models
stargazer(fd_sdg_spi, fd_sdg_spi_L1, fd_sdg_spi_L2, 
          se = rob_se_fd,
          title = "Stage 2 Models: SDG ~ SPI (First Difference)",
          align = TRUE,
          dep.var.labels = "SDG Overall Score",
          column.labels = c("Contemporaneous", "Lag 1", "Lag 2"),
          covariate.labels = c("SPI Composite", "Lagged SPI (t-1)", "Lagged SPI (t-2)", "DI Composite", "Lagged DI (t-1)", "Lagged DI (t-2)",  "Log(GDPper-capita)", "Lower-Middle Income (LMIC)", "Upper-Middle Income (UMIC)", "High Income (HIC)", "Intercept"),
          notes = "Robust standard errors clustered by country in parentheses",
          type = "html", 
          report = "vcs*", 
          #keep.stat = c("n", "rsq", "adj.rsq"),
          omit = "factor\\(year\\)",  # Omits year FE from display
          out = "figures/s2_fd_lags.html")
```

# 2.3) Fixed Effects [Stage 2]
```{r}
# Contemporaneous Effect: SDG ~ SPI + DI
fe_sdg_spi <- plm(formula = sdg_overall ~ spi_comp + di_score + log_gdppc + factor(year) + factor(income_level_recoded),
  index = c("country_code", "year"),
  data = panel_data_s2,
  model = "within" #FE
)
summary(fe_sdg_spi, vcov = vcovHC(fe_sdg_spi, cluster = "group", type = "HC1")) # Robust SEs

# Adding Lag1: SPI ~ DI
fe_sdg_spi_L1 <- plm(formula = sdg_overall ~ spi_comp + spi_comp_lag1 + di_score + di_score_lag1 + log_gdppc + factor(income_level_recoded) + factor(year), 
               model = "within", 
               index = c("country_code", "year"),
               data = panel_data_s2)
summary(fe_sdg_spi_L1, vcov = vcovHC(fe_sdg_spi_L1, cluster = "group", type = "HC1"))

# Adding Lag2: SPI ~ DI
fe_sdg_spi_L2 <- plm(formula = sdg_overall ~ spi_comp + spi_comp_lag1 + spi_comp_lag2 + di_score + di_score_lag1 + di_score_lag2 + log_gdppc + factor(income_level_recoded) + factor(year), 
               model = "within", 
               index = c("country_code", "year"),
               data = panel_data_s2)
summary(fe_sdg_spi_L2, vcov = vcovHC(fe_sdg_spi_L2, cluster = "group", type = "HC1"))
```

# Stargazer Table for FE Models
```{r}
# Extracting robust standard errors for the three FE models
rob_se_fe <- list(
  sqrt(diag(vcovHC(fe_sdg_spi, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(fe_sdg_spi_L1, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(fe_sdg_spi_L2, cluster = "group", type = "HC1")))
)
# Generate the stargazer table for FE models
stargazer(fe_sdg_spi, fe_sdg_spi_L1, fe_sdg_spi_L2, 
          se = rob_se_fe,
          title = "Stage 2 Models: SDG ~ SPI (Fixed Effects)",
          align = TRUE,
          dep.var.labels = "SDG Overall Score",
          column.labels = c("Contemporaneous", "Lag 1", "Lag 2"),
          covariate.labels = c("SPI Composite", "Lagged SPI (t-1)", "Lagged SPI (t-2)", "DI Composite", "Lagged DI (t-1)", "Lagged DI (t-2)",  "Log(GDPper-capita)", "Lower-Middle Income (LMIC)", "Upper-Middle Income (UMIC)", "High Income (HIC)", "Intercept"),
          notes = "Robust standard errors clustered by country in parentheses",
          type = "html", 
          report = "vcs*", 
          #keep.stat = c("n", "rsq", "adj.rsq"),
          omit = "factor\\(year\\)",  # Omits year FE from display
          out = "figures/s2_fe_lags.html")
```

## make a stargazer table of all Lag2 models for POLS, FD and FE
```{r}
# Extracting robust standard errors for the three models
rob_se_lag2 <- list(
  sqrt(diag(vcovHC(ols_sdg_spi_L2, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(fd_sdg_spi_L2, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(fe_sdg_spi_L2, cluster = "group", type = "HC1")))
)
# Generate the stargazer table for Lag2 models
stargazer(ols_sdg_spi_L2, fd_sdg_spi_L2, fe_sdg_spi_L2, 
          se = rob_se_lag2,
          title = "Stage 2 Models: SDG ~ SPI (Lag2)",
          align = TRUE,
          dep.var.labels = "SDG Overall Score",
          column.labels = c("POLS", "FD", "FE"),
          covariate.labels = c("SPI Composite", "Lagged SPI (t-1)", "Lagged SPI (t-2)", "DI Composite", "Lagged DI (t-1)", "Lagged DI (t-2)",  "Log(GDPper-capita)", "Lower-Middle Income (LMIC)", "Upper-Middle Income (UMIC)", "High Income (HIC)", "Intercept"),
          notes = "Robust standard errors clustered by country in parentheses",
          type = "html", 
          report = "vcs*", 
          #keep.stat = c("n", "rsq", "adj.rsq"),
          omit = "factor\\(year\\)",  # Omits year FE from display
          out = "figures/s2_lag2_mods.html")
```


# visualize the results using error bar charts that show the coefficient and robust standard error of every lagged effect in the fe_sdg_spi_L2 FE model
```{r}
# Extract coefficients and robust standard errors from the FE model
coefs <- summary(fe_sdg_spi_L2, vcov = vcovHC(fe_sdg_spi_L2, cluster = "group", type = "HC1"))$coefficients
# Create a data frame for visualization
coef_df <- data.frame(
  term = rownames(coefs),
  estimate = coefs[, "Estimate"],
  std.error = coefs[, "Std. Error"]
)
# Create a ggplot error bar chart
ggplot(coef_df, aes(x = term, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), width = 0.2) +
  labs(title = "Lagged Effects in FE Model (sdg_overall ~ spi_comp + di_score + log_gdppc + income_level_recoded)",
       x = "Predictors",
       y = "Coefficient Estimate") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Save the plot
#ggsave("figures/error_bar_fe_sdg_spi_L2.png", width = 10, height = 6)
```

# visualize the results using error bar charts that show the coefficient and robust standard error of every lagged effect in the fd_sdg_spi_L2 FD model
```{r}
# Extract coefficients and robust standard errors from the FD model
coefs_fd <- summary(fd_sdg_spi_L2, vcov = vcovHC(fd_sdg_spi_L2, cluster = "group", type = "HC1"))$coefficients
# Create a data frame for visualization
coef_df_fd <- data.frame(
  term = rownames(coefs_fd),
  estimate = coefs_fd[, "Estimate"],
  std.error = coefs_fd[, "Std. Error"]
)
# Create a ggplot error bar chart for the FD model
ggplot(coef_df_fd, aes(x = term, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), width = 0.2) +
  labs(title = "Lagged Effects in FD Model (sdg_overall ~ spi_comp + di_score + log_gdppc + income_level_recoded)",
       x = "Predictors",
       y = "Coefficient Estimate") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Save the plot
#ggsave("figures/error_bar_fd_sdg_spi_L2.png", width = 10, height = 6)
```

# MODEL MISSPECIFICATION CHECKS [Stage 2]

## RESET Test for Misspecification [STAGE 2]
[ALL VARIABLES NOT UPDATED TO MATCH PRE-MADE LAGS]
```{r eval=FALSE, include=FALSE}
ols_sdg_spi <- lm(sdg_overall ~ spi_comp_lag1 + di_score_lag1 + log_gdppc + factor(income_level_recoded) + factor(year), data = panel_data_s2) # regular linear model
fd_sdg_spi <- lm(sdg_overall ~ spi_diff_lag1 + di_diff_lag1 + log_gdppc_diff + factor(income_level_recoded), data = fd_data)
fe_sdg_spi <- lm(sdg_overall ~ spi_comp_lag1 + di_score_lag1 + log_gdppc + factor(income_level_recoded) + factor(year) + factor(country_code), data = panel_data_s2)

# Run RESET tests w/ Robust SEs [Stage 2]
resettest(ols_sdg_spi, power = 2:3, type = "regressor", 
          vcov = function(x) vcovHC(x, cluster = "group", type = "HC1"))
resettest(fd_sdg_spi, power = 2:3, type = "regressor",
          vcov = function(x) vcovHC(x, cluster = "group", type = "HC1"))
resettest(fe_sdg_spi, power = 2:3, type = "regressor",
          vcov = function(x) vcovHC(x, cluster = "group", type = "HC1"))

# Saving results to a dataframe
s2_reset_results <- data.frame(
  model = c("ols_sdg_spi", "fd_sdg_spi", "fe_sdg_spi"),
  F_statistic = c(resettest(ols_sdg_spi, power = 2:3, type = "regressor", 
                             vcov = function(x) vcovHC(x, cluster = "group", type = "HC1"))$statistic,
                  resettest(fd_sdg_spi, power = 2:3, type = "regressor",
                             vcov = function(x) vcovHC(x, cluster = "group", type = "HC1"))$statistic,
                  resettest(fe_sdg_spi, power = 2:3, type = "regressor",
                             vcov = function(x) vcovHC(x, cluster = "group", type = "HC1"))$statistic),
  p_value = c(resettest(ols_sdg_spi, power = 2:3, type = "regressor", 
                        vcov = function(x) vcovHC(x, cluster = "group", type = "HC1"))$p.value,
              resettest(fd_sdg_spi, power = 2:3, type = "regressor",
                        vcov = function(x) vcovHC(x, cluster = "group", type = "HC1"))$p.value,
              resettest(fe_sdg_spi, power = 2:3, type = "regressor",
                        vcov = function(x) vcovHC(x, cluster = "group", type = "HC1"))$p.value)
)
print(s2_reset_results)

# Save the results to a CSV file
write.csv(s2_reset_results, file = "results_csv/s2_reset_results.csv", row.names = FALSE)
```
Results from the reset test indicate that the null hypothesis of  is rejected for all models, suggesting potential non-linearity or omitted variable bias in the models.




================================================================================
## Stepwise Check: Applying Polynomial Terms [Stage 2]
For this section, all continuous predictors (DI, SPI, Log(GDP)) in non-linear models are centered to avoid multicollinearity issues. 

- **H0:** The relationship between SPI and SDG performance is linear.
- **H1:** The relationship between SPI and SDG performance is non-linear (quadratic or cubic).
```{r eval=FALSE, include=FALSE}
# No quadratic Terms Applied - Baseline [SIGNIFICANT DI]
fe_sdg_spi_base <- plm(formula = sdg_overall ~ dplyr::lag(cen_spi_comp, n = 1) + dplyr::lag(cen_di_score, n = 1) + cen_log_gdppc + factor(income_level_recoded) + factor(year), 
  index = c("country_code", "year"),
  data = panel_data_s2,
  model = "within")
rob_sum_base <- summary(fe_sdg_spi_base, vcov = vcovHC(fe_sdg_spi_base, cluster = "group", type = "HC1"))

# + Quadratic term for SPI [SIGNIFICANT SPI QUAD]
fe_quads_s2_m2 <- plm(formula =
  sdg_overall ~ dplyr::lag(cen_spi_comp, n = 1) + dplyr::lag(cen_spi_comp_quad, n = 1) + dplyr::lag(cen_di_score, n = 1) + cen_log_gdppc + factor(income_level_recoded) + factor(year),
  index = c("country_code", "year"),
  data = panel_data_s2,
  model = "within")
rob_sum_m2 <- summary(fe_quads_s2_m2, vcov = vcovHC(fe_quads_s2_m2, cluster = "group", type = "HC1"))

# + Quadratic terms for SPI and DI
fe_quads_s2_m3 <- plm(formula = sdg_overall ~ dplyr::lag(cen_spi_comp, n = 1) + dplyr::lag(cen_spi_comp_quad, n = 1) + dplyr::lag(cen_di_score, n = 1) + dplyr::lag(cen_di_score_quad, n = 1) + cen_log_gdppc + factor(income_level_recoded) + factor(year),
               model = "within", 
               index = c("country_code", "year"),
               data = panel_data_s2)
rob_sum_m3 <- summary(fe_quads_s2_m3, vcov = vcovHC(fe_quads_s2_m3, cluster = "group", type = "HC1"))

# + Cubic terms for SPI & DI 
fe_cubics_s2_m4 <- plm(formula = sdg_overall ~ dplyr::lag(cen_spi_comp, n = 1) + dplyr::lag(cen_spi_comp_quad, n = 1) + dplyr::lag(cen_spi_comp_cubic, n = 1) + dplyr::lag(cen_di_score, n = 1) + dplyr::lag(cen_di_score_quad, n = 1) + dplyr::lag(cen_di_score_cubic, n = 1) + cen_log_gdppc + factor(income_level_recoded) + factor(year),
               model = "within", 
               index = c("country_code", "year"),
               data = panel_data_s2)
rob_sum_m4 <- summary(fe_cubics_s2_m4, vcov = vcovHC(fe_cubics_s2_m4, cluster = "group", type = "HC1"))

# Extracting robust standard errors for each model
rob_se_base <- coeftest(fe_sdg_spi_base, vcov = vcovHC(fe_sdg_spi_base, cluster = "group", type = "HC1"))
rob_se_m2  <- coeftest(fe_quads_s2_m2, vcov = vcovHC(fe_quads_s2_m2, cluster = "group", type = "HC1"))
rob_se_m3  <- coeftest(fe_quads_s2_m3, vcov = vcovHC(fe_quads_s2_m3, cluster = "group", type = "HC1"))
rob_se_m4 <- coeftest(fe_cubics_s2_m4, vcov = vcovHC(fe_cubics_s2_m4, cluster = "group", type = "HC1"))

# stargazer table 
# [RERUN FULL CHUNK TO RESET NAMES FOR ACURATE RESULTS]
stargazer(fe_sdg_spi_base, fe_quads_s2_m2, fe_quads_s2_m3, fe_cubics_s2_m4, 
          se = list(rob_se_base[, 2], rob_se_m2[, 2], rob_se_m3[, 2], rob_se_m4[, 2]
                    ),
          title = "Applying Polynomial Terms to Stage 2 Models",
          align = TRUE,
          dep.var.labels = "SDG Overall Score",
          column.labels = c("FE Base", "Quad SPI", "Quad SPI+DI", "Cubic SPI+DI"),
          #covariate.labels = c("SPI", "SPI Squared", "DI", "DI Squared",
          #                     "Log GDPpc", "Intercept"),
          notes = "All models apply fixed effects. Robust standard errors clustered by country in parentheses",
          type = "html", # Change to "latex" for LaTeX output or "html" for Word
          report = "vcs*", # Shows significance stars and standard errors
          model.numbers = FALSE,
          keep.stat = c("n", "rsq", "adj.rsq"),
          out = "figures/poly_s2_models.html") #saved as html
```

# Model Selection: Adj. R^2 & AIC/BIC [Stage 2]
```{r eval=FALSE, include=FALSE}
# AIC/BIC function
source('function/plm_aic_bic_function.R')

# AIC/BIC for both models (sourcing function for plm models)
# [RERUN FULL CHUNK TO RESET NAMES FOR ACURATE RESULTS]
plm_aic_bic(rob_sum_base) # regular FE
plm_aic_bic(rob_sum_m2) # quadratic SPI FE
plm_aic_bic(rob_sum_m3) # quadratic SPI + DI FE
plm_aic_bic(rob_sum_m4) # cubic SPI + DI FE
```
**M1: standard FE**
AIC: 2324.805
BIC: 2447.637 #lowest BIC

**M2: quadratic SPI, FE**
AIC: 2307.741 #lowest AIC
BIC: 2451.045

**M3: quadratic SPI + DI, FE**
AIC: 2313.891
BIC: 2477.667

**M4: cubic SPI + DI, FE**
AIC: 2324.069
BIC: 2528.789

## Check for Autocorrelation 
```{r}
# APPLY Wooldridge Test for AR(1) Errors in FE Panel Models: pwartest()
# https://search.r-project.org/CRAN/refmans/plm/html/pwartest.html  
# This is MUCH BETTER for panel data with small T AND unbalanced panels!!!
pwartest(fe_sdg_spi_base) # [significant]

```
Significant p-value indicates the presence of autocorrelation in the residuals of the fixed effects model. This suggests that the errors are correlated over time, which violates one of the key assumptions of linear regression models.

This is corrected by using robust standard errors clustered by country, which accounts for the potential autocorrelation in the residuals.

## Check for Heteroskedasticity
```{r}
# Apply Breusch-Pagan test for heteroskedasticity
bptest(fe_sdg_spi_base, studentize = TRUE) # Heteroskedasticity [significant]
```
The Breusch-Pagan test indicates the presence of heteroskedasticity in the residuals of the fixed effects model. This suggests that the variance of the errors is not constant across observations, which violates another key assumption of linear regression models.

