---
title: "Component 2, Stage 1"
author: "Sevastian Sanchez"
date: "`r Sys.Date()`"
output:
  pdf_document: 
    toc: no
    toc_depth: '3'
    number_sections: yes
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
    number_sections: yes
    highlight: tango
    theme: default
    fig_caption: yes
    df_print: tibble
  word_document: default
  urlcolor: blue
---
```{r}
knitr::opts_chunk$set(
  echo = TRUE, warning = FALSE, message = FALSE,
  tidy = TRUE, tidy.opts = list(width.cutoff = 60) 
)
```

# Set up
```{r}
# set working directory
setwd("~/Documents/GitHub/QMSS_Thesis_Sanchez")

#load libraries/packages
source("packages.R")

# load data
source("Comp2_panel_wrangling.R")
panel_data1 <- panel_data %>% 
  dplyr::select(country_name, country_code, year, spi_comp, di_score, log_gdppc, sdg_overall, income_level_recoded) %>%
  dplyr::arrange(country_code, year)

# how many countries 
length(unique(panel_data1$country_code)) 

# check dimensions
dim(panel_data1) 

# testing dataframes for sensitivity of results 
# panel_data <- panel_data_spi
```
*sensitivity analysis [REVISE -USING PLM::LAGs]*
Basing analysis of dataset sensitivity on FE model of the second order (fe_spi_di_L2)

- Dataset = panel_data_comp1_data, 1336 obs, 167 countries, FE models (di_score_lag2) showed p = 0.07598 (marginally significant)

- Dataset = panel_data_sdg,  1336 obs, 167 countries, FE models (di_score_lag2) showed p = 0.07598 (marginally significant)

- Dataset = panel_data_exclusive, 1296 obs, 162 countries, FE models (di_score_lag2) showed p = 0.079 (marginally significant)

- Dataset = panel_data_spi, 1392 obs, 174 countries, FE models (di_score_lag2) showed p = 0.1497 
(not significant)

# Stage 1 Models (reported):
ols_spi_di_L2
fd_spi_di_L2
fe_spi_di_L2

## Converting to panel data frame
```{r}
panel_data <- pdata.frame(panel_data1, index = c("country_code", "year"))
pdim(panel_data) # check panel dimensions
```

# 1.1) POLS [Stage 1]: SPI ~ DI
The effect of democracy on SPI Performance
```{r}
# Lag2: SPI ~ DI [REPORTED]
ols_spi_di_L2 <- plm(
  formula = spi_comp ~ di_score + plm::lag(di_score, 1) + plm::lag(di_score, 2)
  + log_gdppc 
  + factor(year), 
  model = "pooling", 
  data = panel_data)
summary(ols_spi_di_L2, vcov = vcovHC(ols_spi_di_L2, cluster = "group", type = "HC1"))
```

## Checking which countries are dropped due to missingness
```{r}
# rows actually used in the model
model_rows <- rownames(model.frame(ols_spi_di_L2))
used_ids <- unique(panel_data[model_rows, "country_code"])
dropped_ids <- setdiff(unique(panel_data1$country_code), used_ids)

length(used_ids)      # should be 155
length(dropped_ids)   # should be 7
dropped_ids           # which countries are excluded
```


## POLS Scatterplots
General relationship between SPI and DI
```{r}
# Contemporaneous Relationship: SPI ~ DI
spi_di_scatter <- ggplot(panel_data1, aes(x = di_score, y = spi_comp)) + 
  geom_point(color = "steelblue4", size = 1, alpha = 0.65) +
  geom_smooth(method = "lm", 
              se = TRUE, color = "darkblue", size = 1) +
  labs(
    title = "Higher Democracy → Higher SPI",
    x = "Democracy Index (0-10 Scale)",
    y = "SPI Composite (0-100 Scale)"
  ) +
  theme_minimal()+
  theme(plot.title = element_text(size = 16, face = "bold")) +
  ylim(20, 100)

# Save to specific folder
#ggsave("figures/stage_1_n_2_scatterplots/spi_di_s1_scatterplot.png", spi_di_scatter, width = 6, height = 8)

# Contemporaneous Relationship: SDG ~ DI
sdg_di_scatter <- ggplot(panel_data1, aes(x = di_score, y = sdg_overall)) + 
  geom_point(color = "steelblue4", size = 1, alpha = 0.65) +
  geom_smooth(method = "lm", 
              se = TRUE, color = "#f27405", size = 1) +
  labs(
    title = "Higher Democracy → Higher SDG Score",
    x = "Democracy Index (0-10 Scale) ",
    y = "SDG Composite (0-100 Scale)"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(size = 16, face = "bold")) +
  ylim(39, 90)

#  Combine bw plots 
combined_scatter <- spi_di_scatter + sdg_di_scatter +
  plot_annotation(title = "Democracy & Main Dependent Variables: SPI & SDG Scores",
    theme = theme(
      plot.title = element_text(hjust = 0.5, size = 18),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    )) &
  theme(
    plot.margin = margin(5, 5, 5, 5),  # inner margins around each subplot
    legend.position = "bottom",              
    legend.title = element_blank()
  )
  combined_scatter

# Save bw version 
ggsave("component_2/figures/other/combined_scatter.png", 
       plot = combined_scatter, 
       width = 12, height = 8)

## Creating + saving black and white version
spi_di_scatter_bw <- spi_di_scatter +
  geom_point(color = "grey35", size = 1, alpha = 0.35) +
  geom_smooth(method = "lm", se = TRUE, color = "grey20", size = 1)

sdg_di_scatter_bw <- sdg_di_scatter +
  geom_point(color = "grey35", size = 1, alpha = 0.35) +
  geom_smooth(method = "lm", se = TRUE, color = "grey20", size = 1)

#  Combine bw plots 
combined_scatterplot_bw <- spi_di_scatter_bw + sdg_di_scatter_bw +
  plot_annotation(title = "Democracy & Main Dependent Variables: SPI & SDG Scores",
    theme = theme(
      plot.title = element_text(hjust = 0.5, size = 18),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    )
  ) &
  theme(
    plot.margin = margin(5, 5, 5, 5)  # inner margins around each subplot
  )
combined_scatterplot_bw

# Save bw version 
ggsave("component_2/figures/other/combined_scatter_bw.png", 
       plot = combined_scatterplot_bw, 
       width = 12, height = 8)

```

# 1.2) First Difference [Stage 1]: SPI ~ DI
```{r}
# Lag2: SPI ~ DI [REPORTED]
fd_spi_di_L2 <- plm(
  formula = spi_comp ~ di_score + plm::lag(di_score, 1) + plm::lag(di_score, 2) 
  + log_gdppc
  + factor(year),
  data = panel_data, 
  model = "fd"
)
summary(fd_spi_di_L2, vcov = vcovHC(fd_spi_di_L2, cluster = "group", type = "HC1"))

# CI for all variables (L2 model)
coef <- coef(fd_spi_di_L2)
se <- sqrt(diag(vcovHC(fd_spi_di_L2, cluster = "group", type = "HC1"))) # Get standard errors

crit_value <- qt(0.975, df = nobs(fd_spi_di_L2)-length(coef(fd_spi_di_L2)))
ci_low <- coef - crit_value * se
ci_high <- coef + crit_value * se
cbind(ci_low, ci_high)

# joint significance 
# names(coef(fd_spi_di_L2)) # ensure correct names 
linearHypothesis(
  fd_spi_di_L2,
  c("di_score = 0", "plm::lag(di_score, 1) = 0", "plm::lag(di_score, 2) = 0"),
  vcov. = vcovHC(fd_spi_di_L2, cluster = "group", type = "HC1"), 
  test = "F"
)

# cumulative effects 
linearHypothesis(
  fd_spi_di_L2,
  c("di_score + plm::lag(di_score, 1) + plm::lag(di_score, 2) = 0"),
  vcov. = vcovHC(fd_spi_di_L2, cluster = "group", type = "HC1"), 
  test = "F"
)
```
**Result:**

In terms of *cumulative impact*, based on the FD model and panel data, there is no detectable total impact of changes in di_score (at current, lag 1, or lag 2) on SPI —over these periods.

## First Difference Error Bar Visualization (L2)
```{r}
# Extract coefficients and robust standard errors from the FD model
fd_spi_di_L2_results <- summary(fd_spi_di_L2, vcov = vcovHC(fd_spi_di_L2, cluster = "group", type = "HC1"))
# Create a data frame for visualization
coef_fd_df <- data.frame(
  term = rownames(fd_spi_di_L2_results$coefficients),
  estimate = fd_spi_di_L2_results$coefficients[, "Estimate"],
  std.error = fd_spi_di_L2_results$coefficients[, "Std. Error"]
)
# Create a ggplot error bar chart
ebar_fd <- ggplot(coef_fd_df, aes(x = term, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), width = 0.2) +
  labs(title = "Stage I: Static & Lagged First Difference (SPI~DI)", x = NULL, y = "Coefficient Estimate") +
  theme_minimal() +
  coord_flip() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "steelblue") +
  scale_x_discrete(labels = c("di_score" = "Democracy (DI)", 
                              "plm::lag(di_score, 1)" = "Lagged DI (t-1)", 
                              "plm::lag(di_score, 2)" = "Lagged DI (t-2)", 
                              "log_gdppc" = "Log(GDP per capita)",
                              "(Intercept)" = "Intercept"
                              ),
                   limits = c(
                   "(Intercept)",
                   "log_gdppc",
                    "plm::lag(di_score, 2)",
                    "plm::lag(di_score, 1)",
                    "di_score"
                 ))
ebar_fd

# Save the plot
#ggsave("component_2/figures/stage1/error_bar_fd_spi_di_L2.png", ebar_fd, width = 10, height = 6)
```

# 1.3) Fixed Effects [Stage 1]: SPI ~ DI
```{r}
# Lag2: SPI ~ DI
fe_spi_di_L2 <- plm(
  formula = spi_comp ~ di_score + plm::lag(di_score, 1) + plm::lag(di_score, 2) 
  + log_gdppc 
  + factor(year),
  data = panel_data,
  model = "within")
summary(fe_spi_di_L2, vcov = vcovHC(fe_spi_di_L2, cluster = "group", type = "HC1"))

# joint significance: is there an effect between these three variables? 
linearHypothesis(
  fe_spi_di_L2,
  c("di_score = 0", "plm::lag(di_score, 1) = 0", "plm::lag(di_score, 2) = 0"),
  vcov. = vcovHC(fe_spi_di_L2, cluster = "group", type = "HC1"), 
  test = "F"
)
# ensure correct names 
names(coef(fe_spi_di_L2))

# cumulative effects
linearHypothesis(
  fe_spi_di_L2,
  c("di_score + plm::lag(di_score, 1) + plm::lag(di_score, 2) = 0"),
  vcov. = vcovHC(fe_spi_di_L2, cluster = "group", type = "HC1"), 
  test = "F"
)

# CI for all variables (L2 model)
coef <- coef(fe_spi_di_L2)
se <- sqrt(diag(vcovHC(fe_spi_di_L2, cluster = "group", type = "HC1")))  # Get standard errors
crit_value <- qt(0.975, df = nobs(fe_spi_di_L2)-length(coef(fe_spi_di_L2)))
ci_low <- coef - crit_value * se
ci_high <- coef + crit_value * se
cbind(ci_low, ci_high)
```
**Results:** The joint significance tests for FE show no evidence that DI variables are jointly significant in explaining changes in SPI scores (F = 0.0107, p = 0.9175). This suggests that DI may not have a meaningful incremental impact on SDG outcomes when considering both current and lagged effects.

In terms of *cumulative impact*, based on the FE model and panel data, there is no detectable total impact of changes in di_score (at current, lag 1, or lag 2) on SPI —over these periods. (F = 0.0107, p = 0.9175)

## Fixed Effects Error Bar Visualization 
```{r}
# Extract coefficients and robust standard errors from the FE model
fe_spi_di_L2_results <- summary(fe_spi_di_L2, vcov = vcovHC(fe_spi_di_L2, cluster = "group", type = "HC1"))
# Create a data frame for visualization
coef_df <- data.frame(
  term = rownames(fe_spi_di_L2_results$coefficients),
  estimate = fe_spi_di_L2_results$coefficients[, "Estimate"],
  std.error = fe_spi_di_L2_results$coefficients[, "Std. Error"]
)
# Create a ggplot error bar chart
ebar_fe <- ggplot(coef_df, aes(x = term, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), width = 0.2) +
  labs(title = "Stage I: Static & Lagged Two-Way Fixed Effects (SPI ~ DI)", 
       x = NULL, 
       y = "Coefficient Estimate") +
  theme_minimal() +
  coord_flip() +  # Flip coordinates for better readability
  geom_hline(yintercept = 0, linetype = "dashed", color = "steelblue") +
  # re-labeling x variable lables 
  scale_x_discrete(labels = c("di_score" = "Democracy (DI)", 
                              "plm::lag(di_score, 1)" = "Lagged DI (t-1)", 
                              "plm::lag(di_score, 2)" = "Lagged DI (t-2)", 
                              "log_gdppc" = "Log(GDP per capita)", 
                              "factor(year)2017" = "Year 2017",
                              "factor(year)2018" = "Year 2018",
                              "factor(year)2019" = "Year 2019",
                              "factor(year)2020" = "Year 2020",
                              "factor(year)2021" = "Year 2021",
                              "factor(year)2022" = "Year 2022",
                              "factor(year)2023" = "Year 2023",
                              "Intercept" = "Intercept"
                              ),
                   limits = c(
                   "(Intercept)",
                   "factor(year)2023",
                   "factor(year)2022",
                   "factor(year)2021",
                   "factor(year)2020",
                   "factor(year)2019",
                   "factor(year)2018",
                   "factor(year)2017",
                   "log_gdppc",
                   "plm::lag(di_score, 2)",
                   "plm::lag(di_score, 1)",
                   "di_score"
                 ))
ebar_fe

# Save the plot
#ggsave("component_2/figures/stage1/error_bar_fe_spi_di_L2.png", ebar_fe, width = 10, height = 6)
```

### stargazer table of lag2 models 
```{r eval=FALSE, include=FALSE}
# stargazer table for only lag2 models
stargazer(
  ols_spi_di_L2, fd_spi_di_L2, fe_spi_di_L2,
  se = list(
    coeftest(ols_spi_di_L2, vcov = vcovHC(ols_spi_di_L2, cluster = "group", type = "HC1"))[, 2],
    coeftest(fd_spi_di_L2, vcov = vcovHC(fd_spi_di_L2, cluster = "group", type = "HC1"))[, 2],
    coeftest(fe_spi_di_L2, vcov = vcovHC(fe_spi_di_L2, cluster = "group", type = "HC1"))[, 2]
  ),
  type = "html",
  title = "Stage I Models: Distributive Lagged Effects",
  align = TRUE,
  dep.var.labels = "SPI Overall Score",
  column.labels = c("POLS", "FD", "FE"),
  covariate.labels = c("DI Composite", "Lagged DI (t-1)", "Lagged DI (t-2)", "Log(GDPper-capita)", "Intercept"),
  report = "vcs*",
  notes = "Robust standard errors clustered by country in parentheses",
  omit = "factor\\(year\\)",
  model.names = FALSE,
  out = "component_2/figures/stage1/s1_lag2_mods.html"
)

```

## Effect Sizes Visualization
```{r}
# Results from the main regression table

# DI Coefficients and standard errors 
# Order: Lag t-2, Lag t-1, Current (t)
fd_coef <- c(-0.216740, -0.632255, 0.664082)   # Year 0, Year 1, Year 2
fd_se   <- c(0.323727, 0.310471, 0.418547)

twfe_coef <- c(-0.449, -0.334, 0.712)  # Year 0, Year 1, Year 2
twfe_se   <- c(0.525, 0.368, 0.550)

# Calculate 95% CIs (±1.96*SE)
fd_lower <- fd_coef - 1.96 * fd_se
fd_upper <- fd_coef + 1.96 * fd_se

twfe_lower <- twfe_coef - 1.96 * twfe_se
twfe_upper <- twfe_coef + 1.96 * twfe_se

# Calculate cumulative effects
fd_cumul <- cumsum(fd_coef)
twfe_cumul <- cumsum(twfe_coef)

# Calculate cumulative CIs (uncertainty compounds)
# For cumulative: Var(sum) = sum of variances (assuming independence)
fd_cumul_se <- sqrt(cumsum(fd_se^2))
fd_cumul_lower <- fd_cumul - 1.96 * fd_cumul_se
fd_cumul_upper <- fd_cumul + 1.96 * fd_cumul_se

twfe_cumul_se <- sqrt(cumsum(twfe_se^2))
twfe_cumul_lower <- twfe_cumul - 1.96 * twfe_cumul_se
twfe_cumul_upper <- twfe_cumul + 1.96 * twfe_cumul_se

# Create data frames
periods <- c(0, 1, 2)
period_labels <- c("Year 0", "Year 1", "Year 2")

# Instantaneous effects data
instant_data <- data.frame(
  period = rep(periods, 2),
  label = rep(period_labels, 2),
  effect = c(fd_coef, twfe_coef),
  lower = c(fd_lower, twfe_lower),
  upper = c(fd_upper, twfe_upper),
  model = rep(c("FD", "TWFE"), each = 3)
)

# Cumulative effects data
cumul_data <- data.frame(
  period = rep(periods, 2),
  label = rep(period_labels, 2),
  effect = c(fd_cumul, twfe_cumul),
  lower = c(fd_cumul_lower, twfe_cumul_lower),
  upper = c(fd_cumul_upper, twfe_cumul_upper),
  model = rep(c("FD", "TWFE"), each = 3)
)

# Plot 1: Instantaneous Effects
p1 <- ggplot(instant_data, aes(x = factor(period, labels = period_labels), 
                                y = effect, color = model, fill = model, group = model)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, color = NA) +
  geom_line(linewidth = 1) +
  geom_vline(xintercept = "Year 0", linewidth = 0.25, color = "gray15") +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  scale_fill_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  labs(x = "Time Since Democracy Increase", 
       y = "Effect per Period",
       title = "Period-Specific Effects") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 11, face = "bold"))

# Plot 2: Cumulative Effects
p2 <- ggplot(cumul_data, aes(x = factor(period, labels = period_labels), 
                              y = effect, color = model, fill = model, group = model)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, color = NA) +
  geom_line(linewidth = 1) +
  geom_vline(xintercept = "Year 0", linewidth = 0.25, color = "gray15") +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  scale_fill_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  labs(x = "Time Since Democracy Increase", 
       y = "Cumulative Effect",
       title = "Cumulative Effects Over Time") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 11, face = "bold"))

# Combine plots
combined_plot <- p1 + p2 + 
  plot_layout(guides = "collect") +
  plot_annotation(
    title = "Dynamic Effects of Democracy on Statistical Capacity\n(with 95% Confidence Intervals)",
    subtitle = "Tracking effects over time following a one-unit increase in democracy",
    theme = theme(
      plot.title = element_text(hjust = 0.5, size = 14),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    )
  ) &
  theme(
    plot.margin = margin(5, 5, 5, 5),  # inner margins around each subplot
    legend.position = "bottom",              
    legend.title = element_blank()
  )
combined_plot

# Save normally
ggsave("component_2/figures/stage1/twfe_fd_dynamic_effects_s1_color.png", 
       plot = combined_plot, 
       width = 12, height = 6)

## Creating + saving black and white version
p1_bw <- p1 +
  scale_color_manual(values = c("FD" = "grey20", "TWFE" = "grey45")) +
  scale_fill_manual(values = c("FD" = "grey20", "TWFE" = "grey45"))
p2_bw <- p2 +
  scale_color_manual(values = c("FD" = "grey20", "TWFE" = "grey45")) +
  scale_fill_manual(values = c("FD" = "grey20", "TWFE" = "grey45"))

#  Combine bw plots 
combined_plot_bw <- p1_bw + p2_bw +
  plot_layout(guides = "collect") +
  plot_annotation(title = "Dynamic Effects of Democracy on Statistical Capacity\n(with 95% Confidence Intervals)",
    theme = theme(
      plot.title = element_text(hjust = 0.5, size = 18),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    )
  ) &
  theme(
    plot.margin = margin(5, 5, 5, 5), # inner margins around each subplot
    legend.position = "bottom",              
    legend.title = element_blank()
  )
combined_plot_bw

# Save bw version 
ggsave("component_2/figures/stage1/twfe_fd_dynamic_effects_s1_bw.png", 
       plot = combined_plot_bw, 
       width = 12, height = 6)
```


## Check for Autocorrelation 
```{r}
# APPLY Wooldridge Test for AR(1) Errors in FE Panel Models: pwartest()
# https://search.r-project.org/CRAN/refmans/plm/html/pwartest.html  
# This is MUCH BETTER for panel data with small T AND unbalanced panels!!!
pbgtest(fe_spi_di_L2) # Panel
pwartest(fe_spi_di_L2) # FE [significant]
pwfdtest(fd_spi_di_L2) # FD [significant]
```
Significant p-value indicates the presence of autocorrelation in the residuals of the fixed effects model. This suggests that the errors are correlated over time, which violates one of the key assumptions of linear regression models.

This is corrected by using robust standard errors clustered by country, which accounts for the potential autocorrelation in the residuals.

## Check for Heteroskedasticity
```{r}
# Apply Breusch-Pagan test for heteroskedasticity
bptest(fe_spi_di_L2, studentize = TRUE) # Heteroskedasticity [significant]
bptest(fd_spi_di_L2, studentize = TRUE) # Heteroskedasticity [significant]
```
The Breusch-Pagan test indicates the presence of heteroskedasticity in the residuals of the fixed effects model. This suggests that the variance of the errors is not constant across observations, which violates another key assumption of linear regression models.


## Residual Diagnostics
### PLOS Residuals for mediator model: SPI ~ DI + Controls [STAGE 1]
```{r}
# Extract the data actually used in the model
ols_spi_di <- lm(spi_comp ~ di_score + log_gdppc + factor(year), data = panel_data) # regular linear model
model_data1 <- model.frame(ols_spi_di)

# switch to all stage-one plots 
png("component_2/figures/stage1/all_s1_residual_plots.png", width = 8, height = 6.5, units = "in", res = 300)
par(mfrow = c(3, 3))

# Residuals vs Fitted Values plot for ols_spi_di
plot(ols_spi_di, which = 1,
     main = "Residuals vs Fitted Model", caption = "ols_spi_di [Stage 1]", pch = 1, cex = 0.35, col = "#595959")
abline(h = 0, col = "black", lty = 2, lwd = 1)
fitted_vals <- fitted(ols_spi_di)
lines(lowess(fitted_vals, resid(ols_spi_di)), col = "red", lwd =  1.5)

# Residuals vs di_score plot
plot(model_data1$di_score, resid(ols_spi_di),
     xlab = "di_score",  ylab = "", yaxt = "n", main = "Residuals vs di_score", pch = 1, cex = 0.35, col = "darkred")
abline(h = 0, col = "black", lty = 2, lwd = 1)
lines(lowess(model_data1$di_score, resid(ols_spi_di)), col = "red", lwd = 1.5)

# Residuals vs log_gdppc plot
plot(model_data1$log_gdppc, resid(ols_spi_di),
     xlab = "log_gdppc",  ylab = "", yaxt = "n", main = "Residuals vs log_gdppc", pch = 1, cex = 0.35, col = "darkgreen")
abline(h = 0, col = "black", lty = 2, lwd = 1)
lines(lowess(model_data1$log_gdppc, resid(ols_spi_di)), col = "red", lwd =  1.5)

#dev.off() # to save 

#par(mfrow = c(1, 1))
```

### First Differences Residuals for mediator model: SPI ~ DI + Controls [STAGE 1]
```{r}
# Extract the data actually used in the model
fd_spi_di <- lm(spi_diff ~ di_diff + log_gdppc_diff, data = fd_data)
model_data_fd1 <- model.frame(fd_spi_di)

# saving as png
#png("figures/residual_plots/fd1_residual_plots.png", width = 8, height = 3, units = "in", res = 300)
#par(mfrow = c(1, 3))

# Residuals vs Fitted Values plot for fd_spi_di
plot(fd_spi_di, which = 1,
     main = "FD Residuals vs Fitted Model", caption = "fd_spi_di [Stage 1]", pch = 1, cex = 0.35, col = "#595959")
abline(h = 0, col = "black", lty = 2, lwd = 1)
fitted_vals_fd <- fitted(fd_spi_di)
lines(lowess(fitted_vals_fd, resid(fd_spi_di)), col = "red", lwd =  1.5)

# Residuals vs di_diff plot
plot(model_data_fd1$di_diff, resid(fd_spi_di),
     xlab = "di_diff",  ylab = "", yaxt = "n", main = "FD Residuals vs di_diff", pch = 1, cex = 0.35, col = "darkred")
abline(h = 0, col = "black", lty = 2, lwd = 1)
lines(lowess(model_data_fd1$di_diff, resid(fd_spi_di)), col = "red", lwd = 1.5)

# Residuals vs log_gdppc_diff plot
plot(model_data_fd1$log_gdppc_diff, resid(fd_spi_di),
     xlab = "log_gdppc_diff",  ylab = "", yaxt = "n", main = "FD Residuals vs log_gdppc_diff", pch = 1, cex = 0.35, col = "darkgreen")
abline(h = 0, col = "black", lty = 2, lwd = 1)
lines(lowess(model_data_fd1$log_gdppc_diff, resid(fd_spi_di)), col = "red", lwd =  1.5)

#dev.off() # to save
#par(mfrow = c(1, 1))
```

### FE Residuals for mediator model: SPI ~ DI + Controls [STAGE 1]
```{r}
# Extract the data actually used in the model
fe_spi_di <- lm(spi_comp ~ di_score + log_gdppc + factor(year) + factor(country_code), data = panel_data)
model_data_fe1 <- model.frame(fe_spi_di)

# saving as png
#png("figures/residual_plots/fe1_residual_plots.png", width = 8, height = 3, units = "in", res = 300)
#par(mfrow = c(1, 3))

# Residuals vs Fitted Values plot for fe_spi_di
plot(fe_spi_di, which = 1,
     main = "FE Residuals vs Fitted Model", caption = "fe_spi_di [Stage 1]", pch = 1, cex = 0.35, col = "#595959")
abline(h = 0, col = "black", lty = 2, lwd = 1)
fitted_vals_fe <- fitted(fe_spi_di)
lines(lowess(fitted_vals_fe, resid(fe_spi_di)), col = "red", lwd =  1.5)

# Residuals vs di_score plot
plot(model_data_fe1$di_score, resid(fe_spi_di),
     xlab = "di_score",  ylab = "", yaxt = "n", main = "FE Residuals vs di_score", pch = 1, cex = 0.35, col = "darkred")
abline(h = 0, col = "black", lty = 2, lwd = 1)
lines(lowess(model_data_fe1$di_score, resid(fe_spi_di)), col = "red", lwd = 1.5)

# Residuals vs log_gdppc plot
plot(model_data_fe1$log_gdppc, resid(fe_spi_di),
     xlab = "log_gdppc",  ylab = "", yaxt = "n", main = "FE Residuals vs log_gdppc", pch = 1, cex = 0.35, col = "darkgreen")
abline(h = 0, col = "black", lty = 2, lwd = 1)
lines(lowess(model_data_fe1$log_gdppc, resid(fe_spi_di)), col = "red", lwd =  1.5)

dev.off() # to save
par(mfrow = c(1, 1))
```
