---
title: "Component 2, Stage 2"
author: "Sevastian Sanchez"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: no
    toc_depth: '3'
    number_sections: yes
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
    number_sections: yes
    highlight: tango
    theme: default
    fig_caption: yes
    df_print: tibble
  word_document: default
  urlcolor: blue
---
```{r}
knitr::opts_chunk$set(
  echo = TRUE, warning = FALSE, message = FALSE,
  tidy = TRUE, tidy.opts = list(width.cutoff = 60) 
)
```

# Set up
```{r}
# set working directory
setwd("~/Documents/GitHub/QMSS_Thesis_Sanchez")

#load libraries/packages
source("packages.R")

# load data
source("Comp2_panel_wrangling.R")

# select relevant variables and arrange data
panel_data1 <- panel_data %>% 
  dplyr::select(country_name, country_code, year, sdg_overall, spi_comp, 
                di_score, log_gdppc, income_level_recoded, di_score_reverse) %>%
  dplyr::arrange(country_code, year)

# how many countries 
length(unique(panel_data1$country_code)) 
```

## Converting to panel data frame
```{r}
panel_data <- pdata.frame(panel_data1, index = c("country_code", "year"))
pdim(panel_data) # check panel dimensions
```

# 2.1) POLS SDG ~ SPI [Stage 2]
```{r}
# Adding Lag2: SPI ~ DI
ols_sdg_spi_L2 <- plm(formula = sdg_overall ~ spi_comp + plm::lag(spi_comp, 1) 
                      + plm::lag(spi_comp, 2) + di_score + plm::lag(di_score, 1) 
                      + plm::lag(di_score, 2) + log_gdppc 
                      #+ factor(income_level_recoded) 
                      + factor(year), 
               model = "pooling", 
               data = panel_data)
summary(ols_sdg_spi_L2, vcov = vcovHC(ols_sdg_spi_L2, cluster = "group", type = "HC1"))
```

## Checking which countries are dropped due to missingness
```{r}
# rows actually used in the model
model_rows <- rownames(model.frame(ols_sdg_spi_L2))
used_ids <- unique(panel_data[model_rows, "country_code"])
dropped_ids <- setdiff(unique(panel_data1$country_code), used_ids)

length(used_ids)      # should be 155
length(dropped_ids)   # should be 7
dropped_ids           # which countries are excluded
```


## POLS Scatterplots
General relationship between SDG and Main Xs: SPI & DI
```{r}
# Contemporaneous Relationship: SDG ~ SPI
sdg_spi_s2_scatter <- ggplot(panel_data1, aes(x = spi_comp, y = sdg_overall)) + 
  geom_point(color = "steelblue4", size = 1, alpha = 0.65) +
  geom_smooth(method = "lm", 
              se = TRUE, color = "darkgreen", size = 1) +
  labs(
    title = "Effect of Statistical Capacity on SDG Performance",
    x = "SPI Composite (0-100 Scale)",
    y = "SDG Composite (0-100 Scale)"
  ) +
  theme(plot.title = element_text(size = 14))+
  theme_minimal()

# Save to specific folder
#ggsave("component_2/figures/stage2/sdg_spi_s2_scatterplot.png", sdg_spi_s2_scatter, width = 8, height = 6)

# Contemporaneous Relationship: SDG ~ DI
sdg_di_s2_scatter <- ggplot(panel_data1, aes(x = di_score, y = sdg_overall)) + 
  geom_point(color = "steelblue4", size = 1, alpha = 0.65) +
  geom_smooth(method = "lm", 
              se = TRUE, color = "#f27405", size = 1) +
  labs(
    title = "Effect of Democracy Levels on SDG Performance",
    x = "DI Composite (0-10 Scale)",
    y = "SDG Composite (0-100 Scale)"
  ) +
  theme(plot.title = element_text(size = 14))+
  theme_minimal()

# Save to specific folder
#ggsave("component_2/figures/stage2/sdg_di_s2_scatterplot.png", sdg_di_s2_scatter, width = 8, height = 6)

# side by side comparison using patchwork 
library(patchwork)
sdg_spi_s2_scatter + sdg_di_s2_scatter + plot_layout(ncol = 2)
#ggsave("component_2/figures/stage2/s2_scatterplots.png", width = 12, height = 8)
```

# 2.2) First Difference [Stage 2]
```{r}
# Lag2: SPI ~ DI [REPORTED]
fd_sdg_spi_L2 <- plm(formula = sdg_overall ~ spi_comp 
                     + plm::lag(spi_comp, 1) + plm::lag(spi_comp, 2) 
                     + di_score + plm::lag(di_score, 1) + plm::lag(di_score, 2) 
                     + log_gdppc,
                     #+ factor(income_level_recoded), 
               model = "fd", 
               data = panel_data)
summary(fd_sdg_spi_L2, vcov = vcovHC(fd_sdg_spi_L2, cluster = "group", type = "HC1"))


# CI 
coef <- coef(fd_sdg_spi_L2)
se <- sqrt(diag(vcovHC(fd_sdg_spi_L2, cluster = "group", type = "HC1")))  # Get standard errors
crit_value <- qt(0.975, df = nobs(fd_sdg_spi_L2)-length(coef(fd_sdg_spi_L2)))
ci_low <- coef - crit_value * se
ci_high <- coef + crit_value * se
cbind(ci_low, ci_high)

# Joint significance of DI scores - FD
linearHypothesis(
  fd_sdg_spi_L2,
  c("di_score = 0", "plm::lag(di_score, 1) = 0", "plm::lag(di_score, 2) = 0"),
  vcov. = vcovHC(fd_sdg_spi_L2, cluster = "group", type = "HC1")
)
# ensure correct names 
# names(coef(fd_sdg_spi_L2))

# cumulative effects of DI scores - FD
linearHypothesis(
  fd_sdg_spi_L2,
  c("di_score + plm::lag(di_score, 1) + plm::lag(di_score, 2) = 0"),
  vcov. = vcovHC(fd_sdg_spi_L2, cluster = "group", type = "HC1")
)

# Joint significance of SPI scores - FD
linearHypothesis(
  fd_sdg_spi_L2,
  c("spi_comp = 0", "plm::lag(spi_comp, 1) = 0", "plm::lag(spi_comp, 2) = 0"),
  vcov. = vcovHC(fd_sdg_spi_L2, cluster = "group", type = "HC1")
)
# ensure correct names 
# names(coef(fd_sdg_spi_L2))

# cumulative effects of SPI scores - FD
linearHypothesis(
  fd_sdg_spi_L2,
  c("spi_comp + plm::lag(spi_comp, 1) + plm::lag(spi_comp, 2) = 0"),
  vcov. = vcovHC(fd_sdg_spi_L2, cluster = "group", type = "HC1")
)
```
**Result (DI Variables):** The *joint significance* tests for FD show no evidence that DI variables are jointly significant in explaining changes in SDG overall scores (Chisq = 5.9731, p = 0.1129), holding SPI terms and all else constant. This suggests that shifts in democracy levels may not have a meaningful immediate impact on SDG performance when considering both current and lagged effects, and accounting for SPI and other controls.

In terms of *cumulative impact*, based on the FD model and panel data, there is no detectable total impact of changes in di_score (at current, lag 1, or lag 2) on SDG performance—over these periods (stat = 0.3872, p = 0.5338).

**Result (SPI Variables):** The *joint significance* tests for FD show marginal evidence that SPI variables are jointly significant in explaining changes in SDG overall scores (Chisq = 7.2282, alpha = 0.1, p = 0.06497), holding DI terms and all else constant. This suggests that shifts in statistical capacity may negligibly have a legitimate immediate impact on SDG performance when considering both current and lagged effects, and accounting for DI and other controls.

In terms of *cumulative impact*, based on the FD model and panel data, there is a detectable total impact of changes in spi_comp (at current, lag 1, or lag 2) on SDG performance—over these periods (stat = 6.4111, p = 0.01134)

## First Difference Error Bar Visualization
```{r}
# Extract coefficients and robust standard errors from the FD model
coefs_fd <- summary(fd_sdg_spi_L2, vcov = vcovHC(fd_sdg_spi_L2, cluster = "group", type = "HC1"))$coefficients
# Create a data frame for visualization
coef_df_fd <- data.frame(
  term = rownames(coefs_fd),
  estimate = coefs_fd[, "Estimate"],
  std.error = coefs_fd[, "Std. Error"]
)
# Create a ggplot error bar chart for the FD model
ebar_fd <- ggplot(coef_df_fd, aes(x = term, y = estimate)) +
  geom_point() +
  coord_flip() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "steelblue") +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), 
                width = 0.2) +
  labs(title = "Stage II: Static & Lagged TWFE (SDG ~ SPI + DI)",
       x = NULL,
       y = "Coefficient Estimate") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_x_discrete(labels = c("di_score" = "Democracy (DI)", 
                              "plm::lag(di_score, 1)" = "Lagged DI (t-1)", 
                              "plm::lag(di_score, 2)" = "Lagged DI (t-2)", 
                              "spi_comp" = "Statistical Performance (SPI)",
                              "plm::lag(spi_comp, 1)" = "Lagged SPI (t-1)",
                              "plm::lag(spi_comp, 2)" = "Lagged SPI (t-2)",
                              "log_gdppc" = "Log(GDP per capita)"
                              ),
                   limits = c(
                   "di_score", 
                   "plm::lag(di_score, 1)",
                   "plm::lag(di_score, 2)",
                   "spi_comp",
                   "plm::lag(spi_comp, 1)",
                   "plm::lag(spi_comp, 2)",
                   "log_gdppc"
                 ))

ebar_fd

# Save the plot
#ggsave("component_2/figures/stage2/error_bar_fd_sdg_spi_L2.png", ebar_fd, width = 10, height = 6)
```

# 2.3) Fixed Effects [Stage 2]
```{r}
# Adding Lag2: SPI ~ DI
fe_sdg_spi_L2 <- plm(formula = sdg_overall ~ spi_comp + plm::lag(spi_comp, 1) 
                     + plm::lag(spi_comp, 2) + di_score + plm::lag(di_score, 1) 
                     + plm::lag(di_score, 2) + log_gdppc 
                     #+ factor(income_level_recoded) 
                     + factor(year), 
               model = "within", 
               data = panel_data)
summary(fe_sdg_spi_L2, vcov = vcovHC(fe_sdg_spi_L2, cluster = "group", type = "HC1"))

# CI for all variables (L2 model)
coef <- coef(fe_sdg_spi_L2)
se <- sqrt(diag(vcovHC(fe_sdg_spi_L2, cluster = "group", type = "HC1")))  # Get standard errors
crit_value <- qt(0.975, df = nobs(fe_sdg_spi_L2)-length(coef(fe_sdg_spi_L2)))
ci_low <- coef - crit_value * se
ci_high <- coef + crit_value * se
cbind(ci_low, ci_high)

# Joint significance FE - DI scores
linearHypothesis(
  fe_sdg_spi_L2,
  c("di_score = 0", "plm::lag(di_score, 1) = 0", "plm::lag(di_score, 2) = 0"),
  vcov. = vcovHC(fe_sdg_spi_L2, cluster = "group", type = "HC1")
)
# ensure correct names 
# names(coef(fe_sdg_spi_L2))

# cumulative effects of DI scores - FE
linearHypothesis(
  fe_sdg_spi_L2,
  c("di_score + plm::lag(di_score, 1) + plm::lag(di_score, 2) = 0"),
  vcov. = vcovHC(fe_sdg_spi_L2, cluster = "group", type = "HC1")
)

# Joint significance FE - DI scores
linearHypothesis(
  fe_sdg_spi_L2,
  c("spi_comp = 0", "plm::lag(spi_comp, 1) = 0", "plm::lag(spi_comp, 2) = 0"),
  vcov. = vcovHC(fe_sdg_spi_L2, cluster = "group", type = "HC1")
)

# cumulative effects of SPI scores - FE
linearHypothesis(
  fe_sdg_spi_L2,
  c("spi_comp + plm::lag(spi_comp, 1) + plm::lag(spi_comp, 2) = 0"),
  vcov. = vcovHC(fe_sdg_spi_L2, cluster = "group", type = "HC1")
)
# ensure correct names 
# names(coef(fe_sdg_spi_L2))
```
**Result (DI Variables):** The *joint significance* tests for FE show evidence that DI variables are jointly significant in explaining changes in SDG overall scores (Chisq = 10.873, p = 0.01244), holding SPI terms and all else constant. This suggests that shifts in democracy levels have a meaningful incremental impact on SDG performance when considering both current and lagged effects, and accounting for SPI and other controls.

In terms of *cumulative impact*, based on the FE model and panel data, there is no detectable total impact of changes in di_score (at current, lag 1, or lag 2) on SDG performance—over these periods (stat = 0.4482, p = 0.5032).

Interestingly, this suggest that the effect is not consistent over time, with short term impacts lasting up to 2 years, but not accumulating over time.


**Result (SPI Variables):** The *joint significance* tests for FE show evidence that SPI variables are jointly significant in explaining changes in SDG overall scores (Chisq = 10.214, p = 0.01683), holding DI terms and all else constant. This suggests that shifts in statistical capacity have a legitimate incremental impact on SDG performance when considering both current and lagged effects, and accounting for DI and other controls.

In terms of *cumulative impact*, based on the FE model and panel data, there is relatively stong evidence of detectable total impact of changes in spi_comp (at current, lag 1, or lag 2) on SDG performance—over these periods (stat = 9.3778, p = 0.002196 **)

## Fixed Effects Error Bar Visualization 
```{r}
# Extract coefficients and robust standard errors from the FE model
coefs <- summary(fe_sdg_spi_L2, vcov = vcovHC(fe_sdg_spi_L2, cluster = "group", 
                                              type = "HC1"))$coefficients
# Create a data frame for visualization
coef_df <- data.frame(
  term = rownames(coefs),
  estimate = coefs[, "Estimate"],
  std.error = coefs[, "Std. Error"]
)
# Create a ggplot error bar chart
ebar_fe <- ggplot(coef_df, aes(x = term, y = estimate)) +
  geom_point() +
  coord_flip() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "steelblue") +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), 
                width = 0.2) +
  labs(title = "Stage II: Static & Lagged TWFE (SDG ~ SPI + DI)",
       x = NULL,
       y = "Coefficient Estimate") +
  theme_minimal() +
  theme(axis.text.x = element_text(hjust = 1)) +
  scale_x_discrete(labels = c("di_score" = "Democracy (DI)", 
                              "plm::lag(di_score, 1)" = "Lagged DI (t-1)", 
                              "plm::lag(di_score, 2)" = "Lagged DI (t-2)", 
                              "spi_comp" = "Statistical Performance (SPI)",
                              "plm::lag(spi_comp, 1)" = "Lagged SPI (t-1)",
                              "plm::lag(spi_comp, 2)" = "Lagged SPI (t-2)",
                              "log_gdppc" = "Log(GDP per capita)",
                              "factor(year)2017" = "Year 2017",
                              "factor(year)2018" = "Year 2018",
                              "factor(year)2019" = "Year 2019",
                              "factor(year)2020" = "Year 2020",
                              "factor(year)2021" = "Year 2021",
                              "factor(year)2022" = "Year 2022",
                              "factor(year)2023" = "Year 2023",
                              "Intercept" = "Intercept"
                              ),
                   limits = c(
                   "di_score", 
                   "plm::lag(di_score, 1)",
                   "plm::lag(di_score, 2)",
                   "spi_comp",
                   "plm::lag(spi_comp, 1)",
                   "plm::lag(spi_comp, 2)",
                   "log_gdppc",
                   "factor(year)2017",
                   "factor(year)2018",
                   "factor(year)2019",
                   "factor(year)2020",
                   "factor(year)2021",
                   "factor(year)2022",
                   "factor(year)2023",
                   "Intercept"
                 ))

ebar_fe

# Save the plot
#ggsave("component_2/figures/stage2/error_bar_fe_sdg_spi_L2.png", ebar_fe, width = 10, height = 6)
```

## make a stargazer table of all Lag2 models for POLS, FD and FE
```{r eval=FALSE, include=FALSE}
# Extracting robust standard errors for the three models
rob_se_lag2 <- list(
  sqrt(diag(vcovHC(ols_sdg_spi_L2, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(fd_sdg_spi_L2, cluster = "group", type = "HC1"))),
  sqrt(diag(vcovHC(fe_sdg_spi_L2, cluster = "group", type = "HC1")))
)
# Generate the stargazer table for Lag2 models
stargazer(ols_sdg_spi_L2, fd_sdg_spi_L2, fe_sdg_spi_L2, 
          se = rob_se_lag2,
          title = "Stage II Models: Static & Lagged Effects (SDG ~ SPI + DI)",
          align = TRUE,
          dep.var.labels = "SDG Overall Score",
          column.labels = c("POLS", "FD", "FE"),
          covariate.labels = c("SPI Composite", "Lagged SPI (t-1)", "Lagged SPI (t-2)", "DI Composite", "Lagged DI (t-1)", "Lagged DI (t-2)",  "Log(GDPper-capita)", "Intercept"),
          notes = "Robust standard errors clustered by country in parentheses",
          type = "html", 
          report = "vcs*", 
          #keep.stat = c("n", "rsq", "adj.rsq"),
          omit = "factor\\(year\\)",  # Omits year FE from display
          out = "component_2/figures/stage2/s2_lag2_mods.html")
```

```{r}
# Results from the main regression table

## DIRECT EFFECTS MODEL ###
# First Difference
fd_coef_de <- c(-0.184, 0.148, 0.035)   # t-2, t-1, t
fd_se_de   <- c(0.127, 0.074, 0.091)    # corresponding SEs

# Two-Way Fixed Effects
twfe_coef_de <- c(-0.201, 0.167, 0.096)  # t-2, t-1, t
twfe_se_de   <- c(0.128, 0.100, 0.080)   # corresponding SEs

# Calculate 95% CIs (±1.96*SE)
fd_lower <- fd_coef_de - 1.96 * fd_se_de
fd_upper <- fd_coef_de + 1.96 * fd_se_de

twfe_lower <- twfe_coef_de - 1.96 * twfe_se_de
twfe_upper <- twfe_coef_de + 1.96 * twfe_se_de

# Calculate cumulative effects
fd_cumul <- cumsum(fd_coef_de)
twfe_cumul <- cumsum(twfe_coef_de)

# Calculate cumulative CIs (uncertainty compounds)
# For cumulative: Var(sum) = sum of variances (assuming independence)
fd_cumul_se <- sqrt(cumsum(fd_se_de^2))
fd_cumul_lower <- fd_cumul - 1.96 * fd_cumul_se
fd_cumul_upper <- fd_cumul + 1.96 * fd_cumul_se

twfe_cumul_se <- sqrt(cumsum(twfe_se_de^2))
twfe_cumul_lower <- twfe_cumul - 1.96 * twfe_cumul_se
twfe_cumul_upper <- twfe_cumul + 1.96 * twfe_cumul_se

# Create data frames
periods <- c(0, 1, 2)
period_labels <- c("Lag t-2", "Lag t-1", "Current (t)")

# Instantaneous effects data
instant_data <- data.frame(
  period = rep(periods, 2),
  label = rep(period_labels, 2),
  effect = c(fd_coef_de, twfe_coef_de),
  lower = c(fd_lower, twfe_lower),
  upper = c(fd_upper, twfe_upper),
  model = rep(c("FD", "TWFE"), each = 3)
)

# Cumulative effects data
cumul_data <- data.frame(
  period = rep(periods, 2),
  label = rep(period_labels, 2),
  effect = c(fd_cumul, twfe_cumul),
  lower = c(fd_cumul_lower, twfe_cumul_lower),
  upper = c(fd_cumul_upper, twfe_cumul_upper),
  model = rep(c("FD", "TWFE"), each = 3)
)

# Plot 1: Instantaneous Effects
p1_de <- ggplot(instant_data, aes(x = factor(period, labels = period_labels), 
                                y = effect, color = model, fill = model, group = model)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, color = NA) +
  geom_line(linewidth = 1) +
  geom_vline(xintercept = "Current (t)", linewidth = 0.25, color = "gray15") +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  scale_fill_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  labs(x = "", 
       y = "Effect per Period",
       title = "Instantaneous Effects (Period-by-Period)") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 11, face = "bold"))

# Plot 2: Cumulative Effects
p2_de <- ggplot(cumul_data, aes(x = factor(period, labels = period_labels), 
                              y = effect, color = model, fill = model, group = model)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, color = NA) +
  geom_line(linewidth = 1) +
  geom_vline(xintercept = "Current (t)", linewidth = 0.25, color = "gray15") +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  scale_fill_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  labs(x = "", 
       y = "Cumulative Effect",
       title = "Cumulative Effects Over Time") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 11, face = "bold"))

# Combine plots
combined_plot_de <- p1_de + p2_de + 
  plot_layout(guides = "collect") +
  plot_annotation(title = "Dynamic Effects of Democracy on SDG Performance\n(with 95% Confidence Intervals)",
    theme = theme(
      plot.title = element_text(hjust = 0.5, size = 14),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    )
  ) &
  theme(
    plot.margin = margin(5, 5, 5, 5),  # inner margins around each subplot
    legend.position = "bottom",              
    legend.title = element_blank()
  )
combined_plot_de

# Save normally
ggsave("component_2/figures/stage2/twfe_fd_dynamic_effects_de_s2_color.png", 
       plot = combined_plot_de, 
       width = 12, height = 6)

## Creating + saving black and white version
p1_de_bw <- p1_de +
  scale_color_manual(values = c("FD" = "grey20", "TWFE" = "grey45")) +
  scale_fill_manual(values = c("FD" = "grey20", "TWFE" = "grey45"))
p2_de_bw <- p2_de +
  scale_color_manual(values = c("FD" = "grey20", "TWFE" = "grey45")) +
  scale_fill_manual(values = c("FD" = "grey20", "TWFE" = "grey45"))

#  Combine bw plots 
combined_plot_de_bw <- p1_de_bw + p2_de_bw +
  plot_layout(guides = "collect") +
  plot_annotation(title = "Dynamic Effects of Democracy on SDG Performance\n(with 95% Confidence Intervals)",
    theme = theme(
      plot.title = element_text(hjust = 0.5, size = 14),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    )
  ) &
  theme(
    plot.margin = margin(5, 5, 5, 5),  # inner margins around each subplot
    legend.position = "bottom",              
    legend.title = element_blank()
  )
combined_plot_de_bw

# Save bw version 
ggsave("component_2/figures/stage2/twfe_fd_dynamic_effects_de_s2_bw.png", 
       plot = combined_plot_de_bw, 
       width = 12, height = 6)
```

## MEDIATION EFFECTS MODEL: SPI CONTROL APPLIED
```{r}
### MEDIATION MODEL ###
# First Difference
fd_coef_me <- c(-0.175, 0.185, 0.049)   # t-2, t-1, t
fd_se_me   <- c(0.125, 0.076, 0.096)    # corresponding SEs

# Two-Way Fixed Effects
twfe_coef_me <- c(-0.236, 0.175, 0.126)  # t-2, t-1, t
twfe_se_me   <- c(0.128, 0.097, 0.080)   # corresponding SEs

# Calculate 95% CIs (±1.96*SE)
fd_lower <- fd_coef_me - 1.96 * fd_se_me
fd_upper <- fd_coef_me + 1.96 * fd_se_me

twfe_lower <- twfe_coef_me - 1.96 * twfe_se_me
twfe_upper <- twfe_coef_me + 1.96 * twfe_se_me

# Calculate cumulative effects
fd_cumul <- cumsum(fd_coef_me)
twfe_cumul <- cumsum(twfe_coef_me)

# Calculate cumulative CIs (uncertainty compounds)
# For cumulative: Var(sum) = sum of variances (assuming independence)
fd_cumul_se <- sqrt(cumsum(fd_se_me^2))
fd_cumul_lower <- fd_cumul - 1.96 * fd_cumul_se
fd_cumul_upper <- fd_cumul + 1.96 * fd_cumul_se

twfe_cumul_se <- sqrt(cumsum(twfe_se_me^2))
twfe_cumul_lower <- twfe_cumul - 1.96 * twfe_cumul_se
twfe_cumul_upper <- twfe_cumul + 1.96 * twfe_cumul_se

# Create data frames
periods <- c(0, 1, 2)
period_labels <- c("Lag t-2", "Lag t-1", "Current (t)")

# Instantaneous effects data
instant_data <- data.frame(
  period = rep(periods, 2),
  label = rep(period_labels, 2),
  effect = c(fd_coef_me, twfe_coef_me),
  lower = c(fd_lower, twfe_lower),
  upper = c(fd_upper, twfe_upper),
  model = rep(c("FD", "TWFE"), each = 3)
)

# Cumulative effects data
cumul_data <- data.frame(
  period = rep(periods, 2),
  label = rep(period_labels, 2),
  effect = c(fd_cumul, twfe_cumul),
  lower = c(fd_cumul_lower, twfe_cumul_lower),
  upper = c(fd_cumul_upper, twfe_cumul_upper),
  model = rep(c("FD", "TWFE"), each = 3)
)

# Plot 1: Instantaneous Effects
p1_me <- ggplot(instant_data, aes(x = factor(period, labels = period_labels), 
                                y = effect, color = model, fill = model, group = model)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, color = NA) +
  geom_line(linewidth = 1) +
  geom_vline(xintercept = "Current (t)", linewidth = 0.25, color = "gray15") +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  scale_fill_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  labs(x = "", 
       y = "Effect per Period",
       title = "Instantaneous Effects (Period-by-Period)") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 11, face = "bold"))

# Plot 2: Cumulative Effects
p2_me <- ggplot(cumul_data, aes(x = factor(period, labels = period_labels), 
                              y = effect, color = model, fill = model, group = model)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, color = NA) +
  geom_line(linewidth = 1) +
  geom_vline(xintercept = "Current (t)", linewidth = 0.25, color = "gray15") +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  scale_fill_manual(values = c("FD" = "#3182bd", "TWFE" = "#e6550d")) +
  labs(x = "", 
       y = "Cumulative Effect",
       title = "Cumulative Effects Over Time") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 11, face = "bold"))

# Combine plots
combined_plot_me <- p1_me + p2_me + 
  plot_layout(guides = "collect") +
  plot_annotation(title = "Dynamic Effects of Democracy on SDG Performance\n(with 95% Confidence Intervals)",
    theme = theme(
      plot.title = element_text(hjust = 0.5, size = 14),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    )
  ) &
  theme(
    plot.margin = margin(5, 5, 5, 5),  # inner margins
    legend.position = "bottom",              
    legend.title = element_blank()
  )
combined_plot_me

# Save normally
ggsave("component_2/figures/stage2/twfe_fd_dynamic_effects_me_s2_color.png", 
       plot = combined_plot_me, 
       width = 12, height = 6)

## Creating + saving black and white version
p1_me_bw <- p1_me +
  scale_color_manual(values = c("FD" = "grey20", "TWFE" = "grey45")) +
  scale_fill_manual(values = c("FD" = "grey20", "TWFE" = "grey45"))
p2_me_bw <- p2_me +
  scale_color_manual(values = c("FD" = "grey20", "TWFE" = "grey45")) +
  scale_fill_manual(values = c("FD" = "grey20", "TWFE" = "grey45"))

#  Combine bw plots 
combined_plot_me_bw <- p1_me_bw + p2_me_bw +
  plot_layout(guides = "collect") +
  plot_annotation(title = "Dynamic Effects of Democracy on SDG Performance\n(with 95% Confidence Intervals)",
    theme = theme(
      plot.title = element_text(hjust = 0.5, size = 14),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    )
  ) &
  theme(
    plot.margin = margin(5, 5, 5, 5),  # inner margins 
    legend.position = "bottom",              
    legend.title = element_blank()
  )
combined_plot_me_bw

# Save bw version 
ggsave("component_2/figures/stage2/twfe_fd_dynamic_effects_me_s2_bw.png", 
       plot = combined_plot_de_bw, 
       width = 12, height = 6)
```

## ALL TOGETHER: DIRECT + MEDIATION EFFECTS ###
```{r}
### Creating + saving black and white version
p1_me_bw <- p1_me_bw +
  labs(x = "", y = "Effect per Period", title = NULL)
p2_me_bw <- p2_me_bw +
  labs(x = "", y = "Cumulative Effect", title = NULL)

### ALL TOGETHER: DIRECT + MEDIATION EFFECTS ###
combined_s2_bw <- (p1_de_bw | p2_de_bw) / (p1_me_bw | p2_me_bw) +
  plot_layout(guides = "collect") +
  plot_annotation(title = "Direct & Mediation Effects of Democracy on SDG Performance\n(with 95% Confidence Intervals)", 
      theme = theme(
      plot.title = element_text(hjust = 0.5, size = 18),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    )
  ) &
  theme(
    plot.margin = margin(5, 5, 5, 5),  # inner margins 
    legend.position = "bottom",              
    legend.title = element_blank()
  )
combined_s2_bw

# Save bw version
ggsave("component_2/figures/stage2/twfe_fd_dynamic_effects_s2_all_bw.png", 
       plot = combined_s2_bw, 
       width = 12, height = 9)
```


## Check for Autocorrelation 
```{r}
# APPLY Wooldridge Test for AR(1) Errors in FE Panel Models: pwartest()
# https://search.r-project.org/CRAN/refmans/plm/html/pwartest.html  
# This is MUCH BETTER for panel data with small T AND unbalanced panels!!!
pbgtest(fe_sdg_spi_L2) # Panel
pwartest(fe_sdg_spi_L2) # FE [significant]
pwfdtest(fd_sdg_spi_L2) # FD [not significant]
```
Significant p-value indicates the presence of autocorrelation in the residuals of the fixed effects model. This suggests that the errors are correlated over time, which violates one of the key assumptions of linear regression models.

## Check for Heteroskedasticity
```{r}
# Apply Breusch-Pagan test for heteroskedasticity
bptest(fe_sdg_spi_L2, studentize = TRUE) # Heteroskedasticity [significant]
bptest(fd_sdg_spi_L2, studentize = TRUE) # Heteroskedasticity [significant]
```
The Breusch-Pagan test indicates the presence of heteroskedasticity in the residuals of the fixed effects model. This suggests that the variance of the errors is not constant across observations, which violates another key assumption of linear regression models.

Both violations are corrected by using robust standard errors clustered at the country level, which accounts for autocorrelation and heteroskedasticity.

## Residual Diagnostics
### POLS Residuals for base/outcome model: SDG ~ SPI + DI + Controls [STAGE 2]
```{r}
# Extract the data actually used in the base model
ols_base_lm <- lm(sdg_overall ~ spi_comp + di_score + log_gdppc + factor(year), data = panel_data) # regular linear model
model_data2 <- model.frame(ols_base_lm)

# saving all stage-two plots
png("component_2/figures/stage2/all_s2_residual_plots.png", width = 8.5, height = 6.5, units = "in", res = 300)
par(mfrow = c(3, 4))

# Residuals vs Fitted Values plot for ols_base_lm
plot(ols_base_lm, which = 1,
     main = "Residuals vs Fitted Model", caption = "ols_base [Stage 2]", pch = 1, cex = 0.35, col = "#595959")
abline(h = 0, col = "black", lty = 2, lwd = 1)
fitted_vals <- fitted(ols_base_lm)
lines(lowess(fitted_vals, resid(ols_base_lm)), col = "red", lwd =  1.5)

# Residuals vs spi_comp plots
plot(model_data2$spi_comp, resid(ols_base_lm),
     xlab = "spi_comp", ylab = "", yaxt = "n", main = "Residuals vs spi_comp", pch = 1, cex = 0.35, col = "darkblue")
abline(h = 0, col = "black", lty = 2, lwd = 1)
lines(lowess(model_data2$spi_comp, resid(ols_base_lm)), col = "red", lwd =  1.5)

# Residuals vs di_score plot
plot(model_data2$di_score, resid(ols_base_lm),
     xlab = "di_score", ylab = "", yaxt = "n", main = "Residuals vs di_score", pch = 1, cex = 0.35, col = "darkred")
abline(h = 0, col = "black", lty = 2, lwd = 1)
lines(lowess(model_data2$di_score, resid(ols_base_lm)), col = "red", lwd = 1.5)

# Residuals vs log_gdppc plot
plot(model_data2$log_gdppc, resid(ols_base_lm),
     xlab = "log_gdppc", ylab = "", yaxt = "n", main = "Residuals vs log_gdppc", pch = 1, cex = 0.35, col = "darkgreen")
abline(h = 0, col = "black", lty = 2, lwd = 1)
lines(lowess(model_data2$log_gdppc, resid(ols_base_lm)), col = "red", lwd =  1.5)

#dev.off() # to save 
#par(mfrow = c(1, 1))
```
The residuals vs fitted values plot shows a clear pattern, indicating non-linearity in the relationship between the predictors and the SDG performance. The residuals are not randomly distributed around zero, suggesting that the linear model does not adequately capture the underlying relationship.

### First Differences Residuals for base/outcome model: SDG ~ SPI + DI + Controls [STAGE 2]
```{r}
# Extract the data actually used in the base model
fd_base_lm <- lm(sdg_diff ~ spi_diff + di_diff + log_gdppc_diff, data = fd_data)
model_data_fd2 <- model.frame(fd_base_lm)

# Residuals vs Fitted Values plot for fd_base_lm
plot(fd_base_lm, which = 1,
     main = "FD Residuals vs Fitted Model", caption = "fd_base [Stage 2]", pch = 1, cex = 0.35, col = "#595959")
abline(h = 0, col = "black", lty = 2, lwd = 1)
fitted_vals_fd2 <- fitted(fd_base_lm)
lines(lowess(fitted_vals_fd2, resid(fd_base_lm)), col = "red", lwd =  1.5)

# Residuals vs spi_comp plots
plot(model_data_fd2$spi_diff, resid(fd_base_lm),
     xlab = "spi_diff", ylab = "", yaxt = "n", main = "FD Residuals vs spi_comp", pch = 1, cex = 0.35, col = "darkblue")
abline(h = 0, col = "black", lty = 2, lwd = 1)
lines(lowess(model_data_fd2$spi_diff, resid(fd_base_lm)), col = "red", lwd =  1.5)

# Residuals vs di_score plot
plot(model_data_fd2$di_diff, resid(fd_base_lm),
     xlab = "di_diff",  ylab = "", yaxt = "n", main = "FD Residuals vs di_score", pch = 1, cex = 0.35, col = "darkred")
abline(h = 0, col = "black", lty = 2, lwd = 1)
lines(lowess(model_data_fd2$di_diff, resid(fd_base_lm)), col = "red", lwd = 1.5)

# Residuals vs log_gdppc_diff plot
plot(model_data_fd2$log_gdppc_diff, resid(fd_base_lm),
     xlab = "log_gdppc_diff",  ylab = "", yaxt = "n", main = "FD Residuals vs log_gdppc", pch = 1, cex = 0.35, col = "darkgreen")
abline(h = 0, col = "black", lty = 2, lwd = 1)
lines(lowess(model_data_fd2$log_gdppc_diff, resid(fd_base_lm)), col = "red", lwd =  1.5)

#dev.off() # to save
#par(mfrow = c(1, 1))
```

### FE Residuals for base/outcome model: SDG ~ SPI + DI + Controls [STAGE 2]
```{r}
# Extract the data actually used in the base model
fe_base_lm <- lm(sdg_overall ~ spi_comp + di_score + log_gdppc + factor(year) + factor(country_code), data = panel_data)
model_data_fe2 <- model.frame(fe_base_lm)

# Residuals vs Fitted Values plot for fe_base_lm
plot(fe_base_lm, which = 1,
     main = "FE Residuals vs Fitted Model", caption = "fe_base [Stage 2]", pch = 1, cex = 0.35, col = "#595959")
abline(h = 0, col = "black", lty = 2, lwd = 1)
fitted_vals_fe2 <- fitted(fe_base_lm)
lines(lowess(fitted_vals_fe2, resid(fe_base_lm)), col = "red", lwd =  1.5)

# Residuals vs spi_comp plots
plot(model_data_fe2$spi_comp, resid(fe_base_lm),
     xlab = "spi_comp", ylab = "", yaxt = "n", main = "FE Residuals vs spi_comp", pch = 1, cex = 0.35, col = "darkblue")
abline(h = 0, col = "black", lty = 2, lwd = 1)
lines(lowess(model_data_fe2$spi_comp, resid(fe_base_lm)), col = "red", lwd =  1.5)

# Residuals vs di_score plot
plot(model_data_fe2$di_score, resid(fe_base_lm),
     xlab = "di_score", ylab = "", yaxt = "n", main = "FE Residuals vs di_score", pch = 1, cex = 0.35, col = "darkred")
abline(h = 0, col = "black", lty = 2, lwd = 1)
lines(lowess(model_data_fe2$di_score, resid(fe_base_lm)), col = "red", lwd = 1.5)

# Residuals vs log_gdppc plot
plot(model_data_fe2$log_gdppc, resid(fe_base_lm),
     xlab = "log_gdppc",  ylab = "", yaxt = "n", main = "FE Residuals vs log_gdppc", pch = 1, cex = 0.35, col = "darkgreen")
abline(h = 0, col = "black", lty = 2, lwd = 1)
lines(lowess(model_data_fe2$log_gdppc, resid(fe_base_lm)), col = "red", lwd =  1.5)

dev.off() # to save
par(mfrow = c(1, 1))
```
- No unsusual curvatures or patterns. 
- Homoscedasticity seems reasonable.
- No obvious outliers.
- Residuals appear roughly normally distributed.
- Overall, the residual diagnostics suggest that the linear regression assumptions are reasonably met for both models.



