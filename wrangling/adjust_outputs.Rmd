---
title: "adjust_outputs"
output: html_document
---

### FIRST: Libraries, Directory & Data 

```{r include=FALSE}
# set working directory 
setwd("~/Documents/GitHub/QMSS_Thesis_Sanchez")

#load libraries 
source("packages.R")
```

### SECOND: Run function in r-script: df_years_function.R   
*[ADJUST TIME OR SKIP IF YOU'RE LOADING DATA FROM DIRECTORY]*

```{r eval=FALSE, include=FALSE}
# df_years2.0():[Updated Version] 
# Function used for extracting all available country data from datasets in specified year range

source("wrangling/df_years2.0_Function.R") #load function
#merged_full <- df_years2.0(2004, 2023) #specify start & end year

# Robustness check for missing identifier variables: country_code, country_name and year
check_missing_identifiers <- function(df) {
  missing_rows <- sum(is.na(df$country_code) | is.na(df$country_name) | is.na(df$year))
  print(paste("Number of rows with missing identifiers:", missing_rows))
  return(missing_rows)}
missing_ids <- check_missing_identifiers(merged_full)

# NEW full version as CSV output (unhash when certain)
write_csv(merged_full, file = 'data/Main CSV Outputs/merged_full_NEW.csv')
```

## Dependent Y = SPI (spi_comp)
**Prioritizing spi_comp data**
Deleting all countries without any SPI data 
```{r}
# load 'merged_full_NEW.csv'
merged_full <- read_csv("data/Main CSV Outputs/merged_full_NEW.csv")

# Define SDG columns
spi_cols <- c('p1_use', 'p2_services', 'p3_products', 'p4_sources', 'p5_infra')

# 1) Only countries with atleast 1 value in any of the 5 SPI pillars
all_missing_pillars <- merged_full %>% 
  group_by(country_code, country_name) %>%
  summarise(all_missing = all(if_all(all_of(spi_cols), is.na))) %>%
  filter(all_missing) %>%
  select(country_code, country_name) %>% 
  ungroup()
# Saving countries w missing SPI data
write_csv(all_missing_pillars, "wrangling/adjust_outputs_diagnostics/countries_missing_all_spi.csv")

# Removing countries from main DF 
merged_cleaned_spi_1 <- merged_full %>% 
  filter(!country_code %in% all_missing_pillars$country_code)

# 2) Only countries with atleast 1 value in the SPI composite (spi_comp) in any year
all_missing_spi_comp <- merged_cleaned_spi_1 %>%
  group_by(country_code, country_name) %>%
  summarise(all_missing = all(is.na(spi_comp))) %>%
  filter(all_missing) %>%
  select(country_code, country_name) %>% 
  ungroup()
# Saving countries w missing SPI data
write_csv(all_missing_spi_comp, "wrangling/adjust_outputs_diagnostics/countries_missing_spi_comp.csv")

# Removing countries from main DF
merged_cleaned_spi_2 <- merged_cleaned_spi_1 %>%
  filter(!country_code %in% all_missing_spi_comp$country_code)

# 3) Only countries with 70% of SPI Composite values across all years (2015-2023)

# Define threshold 
threshold <- 70 # 70% of SPI index values must be present for each country to remain

insufficient_spi_comp <- merged_cleaned_spi_2 %>%
  filter(year >= 2015) %>% # Ensure we only consider years from 2015 onwards
  group_by(country_code, country_name) %>%
  summarise(pct_available = mean(!is.na(spi_comp)) * 100) %>%
  filter(pct_available < threshold) %>%
  select(country_code, country_name) %>% 
  ungroup()
# Saving countries w insufficient SPI data  
write_csv(insufficient_spi_comp, "wrangling/adjust_outputs_diagnostics/countries_insufficient_spi_comp.csv")

# Removing countries from main DF
merged_cleaned_spi_3 <- merged_cleaned_spi_2 %>%
  filter(year >= 2015) %>% # Ensure we only consider years from 2015 onwards
  filter(!country_code %in% insufficient_spi_comp$country_code)

# Saving final dataframe 
write_csv(merged_cleaned_spi_3, "data/Main CSV Outputs/merged_cleaned_spi.csv")
```

## Diagnostics: Countries removed from SPI analyses
```{r}
# combining dataframes of filtered countries for spi
countries_not_in_spi_analysis <- bind_rows(all_missing_pillars, all_missing_spi_comp, insufficient_spi_comp) %>%
  distinct(country_code, .keep_all = TRUE) # no duplicates

# Countries removed from SPI analysis
countries_not_in_spi_analysis1 <- read_csv("wrangling/adjust_outputs_diagnostics/countries_missing_all_spi.csv") %>%
  bind_rows(read_csv("wrangling/adjust_outputs_diagnostics/countries_missing_spi_comp.csv")) %>%
  bind_rows(read_csv("wrangling/adjust_outputs_diagnostics/countries_insufficient_spi_comp.csv")) %>%
  distinct(country_code, .keep_all = TRUE) # no duplicates

# Ensuring no discrepancies between saved and active DF
library(testthat) 
test_that("Dataframes are identical", {
  expect_identical(countries_not_in_spi_analysis, countries_not_in_spi_analysis1)
})

# Save if the following if test passes
if (identical(countries_not_in_spi_analysis, countries_not_in_spi_analysis1, num.eq = FALSE, single.NA = FALSE, attrib.as.set = FALSE, ignore.bytecode = FALSE, ignore.environment = FALSE, ignore.srcref = FALSE, extptr.as.ref = TRUE)) {
  write_csv(countries_not_in_spi_analysis, "wrangling/adjust_outputs_diagnostics/countries_not_in_spi_analysis.csv")
} else { stop("Dataframes are not identical. Check for discrepancies.")
}
```

## Dependent Y = SDG (sdg_overall)
**Prioritizing SDG data**
Deleting all countries without any SDG data 
```{r}
# load 'merged_full_NEW.csv'
merged_full <- read_csv("data/Main CSV Outputs/merged_full_NEW.csv")

# Define SDG columns
sdg_cols <- paste0("goal", 1:17) 

# 1) Only countries with atleast 1 value in any of the 17 SDG goals
all_missing_sdgs <- merged_full %>% 
  group_by(country_code, country_name) %>%
  summarise(all_missing = all(if_all(all_of(sdg_cols), is.na))) %>%
  filter(all_missing) %>%
  select(country_code, country_name) %>% 
  ungroup()
# Saving countries w missing SDG data
write_csv(all_missing_sdgs, "wrangling/adjust_outputs_diagnostics/countries_missing_all_sdgs.csv")

# Removing countries from main DF 
merged_cleaned_sdg_1 <- merged_full %>% 
  filter(!country_code %in% all_missing_sdgs$country_code)

# 2) Please filter to only countries with atleast 1 value in the SDG Overall Index (sdg_overall) in any year
all_missing_sdg_overall <- merged_cleaned_sdg_1 %>%
  group_by(country_code, country_name) %>%
  summarise(all_missing = all(is.na(sdg_overall))) %>%
  filter(all_missing) %>%
  select(country_code, country_name) %>% 
  ungroup()
# Saving countries w missing SDG data
write_csv(all_missing_sdg_overall, "wrangling/adjust_outputs_diagnostics/countries_missing_sdg_overall.csv")

# Removing countries from main DF
merged_cleaned_sdg_2 <- merged_cleaned_sdg_1 %>%
  filter(!country_code %in% all_missing_sdg_overall$country_code)

# 3) Only countries with 70% of SDG Index values across all years (2004-2023)
threshold <- 70 # 70% of SDG index values must be present for each country to remain
insufficient_sdg_overall <- merged_cleaned_sdg_2 %>%
  group_by(country_code, country_name) %>%
  summarise(pct_available = mean(!is.na(sdg_overall)) * 100) %>%
  filter(pct_available < threshold) %>%
  select(country_code, country_name) %>% 
  ungroup()
# Saving countries w insufficient SDG data  
write_csv(insufficient_sdg_overall, "wrangling/adjust_outputs_diagnostics/countries_insufficient_sdg_overall.csv")

# Removing countries from main DF
merged_cleaned_sdg_3 <- merged_cleaned_sdg_2 %>%
  filter(!country_code %in% insufficient_sdg_overall$country_code)

# Saving final dataframe 
write_csv(merged_cleaned_sdg_3, "data/Main CSV Outputs/merged_cleaned_sdg.csv")
```

## Diagnostics: Countries removed from SDG analysis
```{r}
# combining dataframes of filtered countries for sdg
countries_not_in_sdg_analysis <- bind_rows(all_missing_sdgs, all_missing_sdg_overall, insufficient_sdg_overall) %>%
  distinct(country_code, .keep_all = TRUE) # Ensure no duplicates

# Countries removed from SPI analysis
countries_not_in_sdg_analysis1 <- read_csv("wrangling/adjust_outputs_diagnostics/countries_missing_all_sdgs.csv") %>%
  bind_rows(read_csv("wrangling/adjust_outputs_diagnostics/countries_missing_sdg_overall.csv")) %>%
  bind_rows(read_csv("wrangling/adjust_outputs_diagnostics/countries_insufficient_sdg_overall.csv")) %>%
  distinct(country_code, .keep_all = TRUE) # Ensure no duplicates

library(testthat) # Ensuring no discrepancies between saved and active DF
test_that("Dataframes are identical", {
  expect_identical(countries_not_in_sdg_analysis, countries_not_in_sdg_analysis1)
})

# save if the following if test passes
if (identical(countries_not_in_sdg_analysis, countries_not_in_sdg_analysis1, num.eq = FALSE, single.NA = FALSE, attrib.as.set = FALSE, ignore.bytecode = FALSE, ignore.environment = FALSE, ignore.srcref = FALSE, extptr.as.ref = TRUE)) {
  write_csv(countries_not_in_sdg_analysis, "wrangling/adjust_outputs_diagnostics/countries_not_in_sdg_analysis.csv")
} else { stop("Dataframes are not identical. Check for discrepancies")
}
```

## Compare missing countries between SPI and SDG analyses
**Please note:** we are comparing dataframes of missing countries NOT the cleaned dataframes of countries that are used in analyses
```{r}
# Number countries not in either analysis 
overlap_countries <- intersect(countries_not_in_spi_analysis$country_code, countries_not_in_sdg_analysis$country_code)
print(paste("Number of countries removed from both SPI and SDG analyses:", length(overlap_countries)))

# Number of countries Missing in SPI that are not Missing in SDG
unique_to_spi <- setdiff(countries_not_in_spi_analysis$country_code, countries_not_in_sdg_analysis$country_code)
print(paste("Number of countries removed only from SPI analysis:", length(unique_to_spi)))

# Number of countries Missing in SDG that are not Missing in SPI
unique_to_sdg <- setdiff(countries_not_in_sdg_analysis$country_code, countries_not_in_spi_analysis$country_code)
print(paste("Number of countries removed only from SDG analysis:", length(unique_to_sdg)))

# Dataframe of all countries removed from either analysis with a column indicating which analysis they were removed from
countries_removed_comparison <- bind_rows(
  countries_not_in_spi_analysis %>% mutate(removed_from = "SPI"),
  countries_not_in_sdg_analysis %>% mutate(removed_from = "SDG")
) %>%
  distinct(country_code, removed_from, .keep_all = TRUE) %>%
  pivot_wider(names_from = removed_from, values_from = removed_from, values_fill = NA) %>%
  mutate(removed_from = case_when(
    !is.na(SPI) & !is.na(SDG) ~ "Not in Either Analysis",
    !is.na(SPI) ~ "Not in SPI Analysis",
    !is.na(SDG) ~ "Not in SDG Analysis"
  )) %>%
  select(country_code, country_name, removed_from)
View(countries_removed_comparison)

# Comparison dataframe: showing which countries were removed from which analysis
write_csv(countries_removed_comparison, "wrangling/adjust_outputs_diagnostics/all_countries_removed_comparison.csv")

# create summary table
summary_counts_all_removed_comparison <- countries_removed_comparison %>%
  group_by(removed_from) %>%
  summarise(num_countries = n()) %>%
  ungroup()
print(summary_table)

# save summary counts table
write_csv(summary_counts_all_removed_comparison, "wrangling/adjust_outputs_diagnostics/summary_counts_all_removed_comparison.csv")
```

### FOURTH: Selecting Variables 
*[ADJUST VARIABLES OR SKIP IF LOADING FROM CSV]*
```{r eval=FALSE, include=FALSE}
# merged_cleaned_sdg_3 <- read_csv("data/Main CSV Outputs/merged_cleaned_sdg.csv")
merged_final_sdg <- merged_cleaned_sdg_3 %>%
  dplyr::select(country_name, country_code, year, sdg_overall, spi_comp, sci_overall, di_score, regime_type_2, regime_type_4, regch_event, aut_ep, dem_ep, elect_dem, lib_dem, part_dem, delib_dem, egal_dem, academ_free, income_level, income_level_lab, gdp_pc, log_gdppc, population, log_pop, p1_use, p2_services, p3_products, p4_sources, p5_infra, goal1, goal2, goal3, goal4, goal5, goal6, goal7, goal8, goal9, goal10, goal11, goal12, goal13, goal14, goal15, goal16, goal17)
#write_csv(merged_final_sdg, 'data/Main CSV Outputs/merged_final_sdg.csv')

# merged_cleaned_spi_3 <- read_csv("data/Main CSV Outputs/merged_cleaned_spi.csv")
merged_final_spi <- merged_cleaned_spi_3 %>%
  dplyr::select(country_name, country_code, year, sdg_overall, spi_comp, sci_overall, di_score, regime_type_2, regime_type_4, regch_event, aut_ep, dem_ep, elect_dem, lib_dem, part_dem, delib_dem, egal_dem, academ_free, income_level, income_level_lab, gdp_pc, log_gdppc, population, log_pop, p1_use, p2_services, p3_products, p4_sources)

#write_csv(merged_final_spi, 'data/Main CSV Outputs/merged_final_spi.csv')
```

# Test for identical DFs
As needed... 
```{r}
library(testthat)

# In a test script
test_that("Dataframes are identical", {
  expect_identical(countries_not_in_spi_analysis, countries_not_in_spi_analysis1)
})
```

