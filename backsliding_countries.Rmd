---
title: "backsliding_countries"
output: html_document
---

# preparation 
```{r}
setwd("~/Documents/GitHub/QMSS_Thesis_Sanchez")

#load libraries 
source("packages.R")

#load data 
event_data_all <- read_csv("data/Main CSV Outputs/merged_final_df.csv")

#selecting vars
event_data <- event_data %>% 
  dplyr::select(country_code, year, sdg_overall, spi_comp, di_score, aut_ep, dem_ep, elect_dem, lib_dem, part_dem, delib_dem, egal_dem, academ_free, income_level, income_level_lab, log_gdppc, population) %>% 
  arrange(country_code, year) %>%  # Critical for correct lagging
  filter(year >= 2016)

# adding has_aut_ep and has_dem_ep for regressing regimes (experienced atleast 1 aut_ep/dem_ep)
event_data <- event_data %>%
  # Group by country to check for any event
  group_by(country_code) %>%
  mutate(has_aut_ep = any(aut_ep == 1, na.rm = TRUE)) %>% # aut_ep countries 
  mutate(has_dem_ep = any(dem_ep == 1, na.rm = TRUE)) %>% # dem_ep countries 
  ungroup() %>% 
  filter(has_aut_ep == TRUE | has_dem_ep == TRUE) #FILTERS TO ONLY CHANGING REGIMES

# subgroups: regressing and democratizing coutries 
aut_data <- event_data %>% filter(has_aut_ep == TRUE) #experienced atleast 1 backsliding event 
dem_data <- event_data %>% filter(has_dem_ep == TRUE) ##experienced atleast 1 democratizing event 
```


# Descriptive stats & Missing Data: Transitioning Countries Dataset 
```{r}
# number of countries that experienced a regime change event (autocratization or democratization)
n_countries_events <- length(unique(event_data$country_code[event_data$aut_ep == 1 | event_data$dem_ep == 1]))
n_countries_events

# number of countries that experienced autocratization
n_countries_aut <- length(unique(event_data$country_code[event_data$aut_ep == 1]))
n_countries_aut

# number of countries that experienced democratization
n_countries_dem <- length(unique(event_data$country_code[event_data$dem_ep == 1]))
n_countries_dem

#Frequency of countries that experienced democratization 2015-2024
hist(dem_data$year[dem_data$regch_event==1], breaks = 20)

#Frequency of countries that experienced autocratization 2015-2024
hist(aut_data$year[aut_data$regch_event==-1], breaks = 20)

#Frequency of countries that experienced no change 2015-2024 [FIX HERE AND BELOW]
hist(merged$year[merged$regch_event==0], breaks = 20)

#frequency/proportion table: instances of backsliding, stability, democratization from 2004-2024
table(merged$regch_event) # frequency
prop.table(table(merged$regch_event)) # proportions 
```






# Backsliding FD Models 
```{r}
###### SPI ~ DI (M ~ X) ######
fd_spi_di_aut <- plm(
  formula = spi_comp ~ di_score + log_gdppc,
  index = c("country_code", "year"),
  data = aut_data, 
  model = "fd" #FD
) 
# Country-level custard Robust SEs
summary(fd_spi_di_aut, vcov = vcovHC(fd_spi_di_aut, cluster = "group", type = "HC1"))

###### SDG ~ SPI (Y ~ M) ######
fd_sdg_spi_aut <- plm(
  formula = sdg_overall ~ spi_comp + di_score + log_gdppc,
  index = c("country_code", "year"),
  data = aut_data, 
  model = "fd"
)
# Country-level custard Robust SEs
summary(fd_sdg_spi_aut, vcov = vcovHC(fd_sdg_spi_aut, cluster = "group", type = "HC1"))
```
On average, when backsliding countries experience a change in Democracy score, is there a change in statistical capacity (SPI)? On average, when backsliding countries experience a change in statistical capacity (SPI) do they similalry experience a change in SDG score? 

# Backsliding FE Models
```{r}
###### SPI ~ DI (M ~ X) ######
fe_spi_di_aut <- plm(
  formula = spi_comp ~ di_score + log_gdppc + factor(year),
  index = c("country_code", "year"),
  data = aut_data,
  model = "within" 
)
summary(fe_spi_di_aut, vcov = vcovHC(fe_spi_di_aut, cluster = "group", type = "HC1")) # Robust SEs

###### SDG ~ SPI (Y ~ M) ######
fe_sdg_spi_aut <- plm(
  sdg_overall ~ spi_comp + di_score + log_gdppc + factor(year),
  index = c("country_code", "year"),
  data = aut_data,
  model = "within" 
)
summary(fe_sdg_spi_aut, vcov = vcovHC(fe_sdg_spi_aut, cluster = "group", type = "HC1")) # Robust SEs
```

# Single Country: Hungary 
```{r}
#filter for hungary 
hun_regressed <- aut_data %>% 
  filter(country_code == "HUN")

# FE model - Hungary 
fe_testing <- plm(
  formula = spi_comp ~ di_score + log_gdppc,
  data = aut_data, sub = (country_code == 'HUN'),
  index = c("country_code", "year"),
  model = "within")
summary(fe_testing, vcov = vcovHC(fe_testing, type = "HC3"))
```

#testing for autocorrelation 
```{r}
lmtest::bgtest(fe_testing)
lmtest::bgtest(fe_testing, order = 1)
```


```{r}
# subset of countries that experienced atleast 1 democratization event 
democratized <- merged %>% 
  group_by(country_code) %>%
  filter(dem_ep == 1) %>%
  ungroup()
```
