---
title: "Temporal_Lags_FD_FE"
author: "Sevastian Sanchez"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#TEMPORAL ANALYSIS: First Difference, Fixed Effects, Checks

##setup: packages and data
```{r}
setwd("~/Documents/GitHub/QMSS_Thesis_Sanchez")

#load libraries 
source("packages.R")

#load data & function 
source("data/data_sources.R")
source("df_years()_Function.R")

#load df_years() function: 2015-present
fd_fe_data <- df_years(yr1=2015) %>%
  dplyr::select(country_code, year, year_fct, sdg_overall, spi_comp, di_score, aut_ep, dem_ep, income_level, income_level_lab, gini, gdppc, log_gdppc, population) %>% 
  arrange(country_code, year)  # Critical for correct lagging
  
```

# OLS: SPI ~ DI [DR. DI GENNERO's MODEL]
```{r}
# Full OLS model: SPI ~ DI
ols_spi_di <- lm(spi_comp ~ di_score + log_gdppc + population + gini + year_fct, data = fd_fe_data)
summary(ols_spi_di)

# plotting
ggplot(fd_fe_data, aes(di_score, spi_comp))+
  geom_point()+
  geom_smooth(method=lm) #makes the line into a linear model

#correlation - variance 
spi_di_cor <- cor(fd_fe_data$spi_comp, fd_fe_data$di_score, use = "complete.obs")
spi_di_cor

#r-squared
spi_di_cor_2 <- cor(fd_fe_data$spi_comp, fd_fe_data$di_score, use = "complete.obs")^2
spi_di_cor_2
```

# Panel Data Analysis 

**First Difference (FD)** removes all time-invariant characteristics of each unit (like geography, culture, or baseline wealth). However, variables that do change over time, such as GDP per capita and country population, should be controlled.

**Fixed Effects (FE)** [description...]

## FD & FE: Regime -> SPI 
```{r}
#First Difference 
fd_spi_di <- plm(
  spi_comp ~ di_score + log_gdppc + population + year_fct,
  data = fd_fe_data,
  index = c("country_code", "year_fct"),
  model = "fd" #FD
)

summary(fd_spi_di)
coeftest(fd_spi_di, vcov = vcovCL(fd_spi_di, cluster = ~country_code)) #Robust SEs 

# Fixed Effects 
fe_spi_di <- plm(
  spi_comp ~ di_score + log_gdppc + population + year_fct,
  data = fd_fe_data,
  index = c("country_code", "year"),
  model = "within" #FE
)

summary(fe_spi_di)
coeftest(fe_spi_di, vcov = vcovCL(fe_spi_di, cluster = ~country_code)) # Robust SEs
```
- Cannot run FD model due to zero-variance or data precision issues. Perhaps the model has too few years to 


## FD & FE: SPI -> SDG 
```{r}
# First Difference 
fd_sdg_spi <- plm(
  sdg_overall ~ spi_comp + di_score + log_gdppc + population + year_fct,
  data = fd_fe_data,
  index = c("country_code", "year"),
  model = "fd" #FD
)

summary(fd_sdg_spi)
coeftest(fd_sdg_spi, vcov = vcovCL(fd_sdg_spi, cluster = ~country_code)) # Robust SEs

# Fixed Effects 
fe_sdg_spi <- plm(
  sdg_overall ~ spi_comp + di_score + log_gdppc + population + year_fct,
  data = fd_fe_data,
  index = c("country_code", "year"),
  model = "within" #FE
)

summary(fe_sdg_spi)
coeftest(fe_sdg_spi, vcov = vcovCL(fe_sdg_spi, cluster = ~country_code)) # Robust SEs
```

## Mediation Effect: connecting DI -> SDGs
Mediation analysis to formally test and quantify SPI's role in transmitting regime change effects to SDGs. This is how to quantify the connection between the Regime Change and the SDGs 
```{r}
# Mediation analysis - FD models 
med_fd_results <- mediate(
  fd_spi_di, # mediator model
  fd_sdg_spi, # outcome model 
  treat = "di_score",   # Treatment variable (regime change)
  mediator = "spi_comp", # SPI mediator
  sims = 1000,        # Number of bootstrap simulations
  robustSE = TRUE     # Cluster SEs by country
)

summary(med_fd_results)

# Sensitivity Analysis: after running mediation
sens_med_fd <- medsens(med_fd_results, rho.by = 0.1)
plot(sens_med_fd)

# Mediation analysis - FE models 
med_fe_results <- mediate(
  fe_spi_di, # mediator model
  fe_sdg_spi, # outcome model 
  treat = "di_score",   # Treatment variable (regime change)
  mediator = "spi_comp", # SPI mediator
  sims = 1000,        # Number of bootstrap simulations
  robustSE = TRUE     # Cluster SEs by country
)

summary(med_fe_results)

# Sensitivity Analysis: after running mediation
sens_med_fe <- medsens(med_fe_results, rho.by = 0.1)
plot(sens_med_fe)

```

# Temporal Dependent Lags
In my study, I speculate that changes in SPI (comes first) produces subsequent changes in SDG progress (comes second). Based on current studies, it can take some time for implementation of statistical capacity structures to produce results.

Furthermore, regime transition may have a delayed effect on statistical capacity, although I suspect it varies in time (do we notice a drop in SPI as a precondition or a symptom of autocratization)

## ACF to Assess Autocorrelation 
ACF checks for independence of errors in regression analysis. This assesses whether x variables are correlated across time to determine correlation at different lags (autocorrelation).
```{r}
# First Difference tests 
lmtest::dwtest(fd_sdg_di)
lmtest::dwtest(fd_sdg_spi)

# Fixed Effects tests 
lmtest::dwtest(fe_sdg_di)
lmtest::dwtest(fe_sdg_spi)
```

## Significant Autocorrelation: create lagged variables and first differences

```{r}
# Create lagged variables and first differences
fd_fe_data <- fd_fe_data %>%
  arrange(country_code, year) %>% 
  group_by(country_code) %>%
  mutate(
    # 1 year lags
    sdg_lag_1 = dplyr::lag(sdg_overall, n = 1),
    spi_lag_1 = dplyr::lag(spi_comp, n = 1),
    di_lag_1 = dplyr::lag(di_score, n = 1),
    # 2-year lags 
    sdg_lag_2 = dplyr::lag(sdg_overall, n = 2),
    spi_lag_2 = dplyr::lag(spi_comp, n = 2),
    di_lag_2 = dplyr::lag(di_score, n = 2),
    
    # Calculate first differences
    fd_sdg_1 = sdg_overall - sdg_lag_1,
    fd_spi_1 = spi_comp - spi_lag_1,
    fd_di_1 = di_score - di_lag_1,
    fd_sdg_2 = sdg_overall - sdg_lag_2,
    fd_spi_2 = spi_comp - spi_lag_2,
    fd_di_2 = di_score - di_lag_2
  ) %>%
  ungroup()

# To verify the lag creation works correctly
#head(fd_data_testing %>% dplyr::select(country_code, year, sdg_overall, sdg_lag, fd_sdg, spi_comp, spi_lag, fd_spi) %>% arrange(country_code, year), 10)
```

## FD & FE + LAGS: SPI ~ DI 
```{r}
#First Difference 
fd_spi_di_lag <- plm(
  spi_comp ~ plm::lag(di_score) + log_gdppc + population + gini + year_fct,
  data = fd_fe_data,
  index = c("country_code", "year"),
  model = "fd" #FD
)

summary(fd_spi_di_lag)
coeftest(fd_spi_di_lag, vcov = vcovCL(fd_spi_di_lag, cluster = ~country_code)) # Robust SEs

# Fixed Effects 
fe_spi_di_lag <- plm(
  spi_comp ~ plm::lag(di_score) + log_gdppc + population + gini + year_fct,
  data = fd_fe_data,
  index = c("country_code", "year"),
  model = "within" #FE
)

summary(fe_spi_di_lag)
coeftest(fe_spi_di_lag, vcov = vcovCL(fe_spi_di_lag, cluster = ~country_code)) # Robust SEs
```


## FD & FE + LAGS: SDG ~ SPI
```{r}
# First Difference 
fd_sdg_spi_lag <- plm(
  sdg_overall ~ plm::lag(spi_comp) + di_score + log_gdppc + population + gini + year_fct,
  data = fd_fe_data,
  index = c("country_code", "year"),
  model = "fd" #FD
)

summary(fd_sdg_spi_lag)
coeftest(fd_sdg_spi_lag, vcov = vcovCL(fd_sdg_spi_lag, cluster = ~country_code)) # Robust SEs

# Fixed Effects 
fe_sdg_spi_lag <- plm(
  sdg_overall ~ plm::lag(spi_comp) + di_score + log_gdppc + population + gini + year_fct,
  data = fd_fe_data,
  index = c("country_code", "year"),
  model = "within" #FE
)

summary(fe_sdg_spi_lag)
coeftest(fe_sdg_spi_lag, vcov = vcovCL(fe_sdg_spi_lag, cluster = ~country_code)) # Robust SEs
```


## Mediation Effect + Lags: connecting DI -> SDGs
```{r}
## CONFIRM THE MED MODELS BELOW ARE OKAY W PERPLEXITY 

# Mediation analysis - FD models 
med_fd_lag_results <- mediate(
  fd_spi_di_lag, # mediator model
  fd_sdg_spi_lag, # outcome model 
  treat = "di_score",   # Treatment variable (regime change)
  mediator = "spi_comp", # SPI mediator
  sims = 1000,        # Number of bootstrap simulations
  robustSE = TRUE     # Cluster SEs by country
)

summary(med_fd_lag_results)

# After running mediation
sens_med <- medsens(med_fd_lag_results, rho.by = 0.1)
plot(sens_med)

# Mediation analysis - FE models 
med_fe_lag_results <- mediate(
  fe_spi_di_lag, # mediator model
  fe_sdg_spi_lag, # outcome model 
  treat = "di_score",   # Treatment variable (regime change)
  mediator = "spi_comp", # SPI mediator
  sims = 1000,        # Number of bootstrap simulations
  robustSE = TRUE     # Cluster SEs by country
)

summary(med_fe_lag_results)

# After running mediation
sens_med <- medsens(med_fe_lag_results, rho.by = 0.1)
plot(sens_med)
```


# Subgroup Analysis 



# FD Subgroup Analysis: SDG ~ SPI + subgroup(income group)

## Models - subgroups by income class 
- No need for time dummy in FD models
```{r}
# Overall model
fd_overall <- lm(fd_sdg ~ fd_spi + log_gdppc + population, 
                data = fd_fe_data %>% 
                  filter(!is.na(fd_sdg) & !is.na(fd_spi)))
summary(fd_overall)

# High income countries
fd_high <- lm(fd_sdg ~ fd_spi + gdppc + population, 
             data = fd_fe_data %>% 
               filter(!is.na(fd_sdg) & !is.na(fd_spi) & 
                     income_level == "High Income Countries"))
summary(fd_high)

# Upper-middle income countries
fd_upper <- lm(fd_sdg ~ fd_spi + log_gdppc + population, 
              data = fd_fe_data %>% 
                filter(!is.na(fd_sdg) & !is.na(fd_spi) & 
                      income_level == "Upper-Middle Income Countries"))
summary(fd_upper)

# Lower-middle income countries
fd_lower <- lm(fd_sdg ~ fd_spi + log_gdppc + population, 
              data = fd_fe_data %>% 
                filter(!is.na(fd_sdg) & !is.na(fd_spi) & 
                      income_level == "Lower-Middle Income Countries"))
summary(fd_lower)

# Low income countries
fd_low <- lm(fd_sdg ~ fd_spi + log_gdppc + population, 
            data = fd_fe_data %>% 
              filter(!is.na(fd_sdg) & !is.na(fd_spi) & 
                    income_level == "Low Income Countries"))
summary(fd_low)
```


## FD Comparison Table: SDG ~ SPI

```{r}
# Extract coefficients and statistics from each model
fd_comparison <- data.frame(
  model = c("Overall", "High Income", "Upper-Middle Income", 
           "Lower-Middle Income", "Low Income"),
  coefficient = c(
    coef(fd_overall)["fd_spi"],
    coef(fd_high)["fd_spi"],
    coef(fd_upper)["fd_spi"],
    coef(fd_lower)["fd_spi"],
    coef(fd_low)["fd_spi"]
  ),
  intercept = c(
    coef(fd_overall)["(Intercept)"],
    coef(fd_high)["(Intercept)"],
    coef(fd_upper)["(Intercept)"],
    coef(fd_lower)["(Intercept)"],
    coef(fd_low)["(Intercept)"]
  ),
  t_value = c(
    summary(fd_overall)$coefficients["fd_spi", "t value"],
    summary(fd_high)$coefficients["fd_spi", "t value"],
    summary(fd_upper)$coefficients["fd_spi", "t value"],
    summary(fd_lower)$coefficients["fd_spi", "t value"],
    summary(fd_low)$coefficients["fd_spi", "t value"]
  ),
  p_value = c(
    summary(fd_overall)$coefficients["fd_spi", "Pr(>|t|)"],
    summary(fd_high)$coefficients["fd_spi", "Pr(>|t|)"],
    summary(fd_upper)$coefficients["fd_spi", "Pr(>|t|)"],
    summary(fd_lower)$coefficients["fd_spi", "Pr(>|t|)"],
    summary(fd_low)$coefficients["fd_spi", "Pr(>|t|)"]
  ),
  r_squared = c(
    summary(fd_overall)$r.squared,
    summary(fd_high)$r.squared,
    summary(fd_upper)$r.squared,
    summary(fd_lower)$r.squared,
    summary(fd_low)$r.squared
  ),
  adj_r_squared = c(
    summary(fd_overall)$adj.r.squared,
    summary(fd_high)$adj.r.squared,
    summary(fd_upper)$adj.r.squared,
    summary(fd_lower)$adj.r.squared,
    summary(fd_low)$adj.r.squared
  ),
  n_obs = c(
    nobs(fd_overall),
    nobs(fd_high),
    nobs(fd_upper),
    nobs(fd_lower),
    nobs(fd_low)
  )
)

# Format the numbers for better display
fd_comparison <- fd_comparison %>%
  mutate(
    coefficient = round(coefficient, 3),
    intercept = round(intercept, 3),
    t_value = round(t_value, 3),
    p_value = round(p_value, 4),
    r_squared = round(r_squared, 3),
    adj_r_squared = round(adj_r_squared, 3)
  )

# Print the comparison table
print(fd_comparison)

#export fd_comparison 
#write.csv(fd_comparison, file = "fd_comparison.csv", row.names=F) 
```

**RESULTS:**

The overall model shows a positive and statistically significant relationship (coefficient = 0.015, p = 0.0033) between improvements in statistical capacity and improvements in SDG performance. Although this confirms my hypothesis that better statistical systems contribute to better development outcomes, the intercept indicates that when SPI remains constant, SDG scores progress by 0.286 anyway.

The income group breakdown reveals fascinating variations:

1.  **High Income Countries** show a negative coefficient (-0.012) that is not statistically significant (p = 0.2537). This suggests that for developed economies, improvements in statistical capacity don't necessarily translate to SDG improvements, possibly because they already have well-established statistical systems and other factors drive their SDG performance.

2.  **Upper-Middle Income Countries** show a stronger positive effect (0.021) that is statistically significant (p = 0.0163). This indicates that for these emerging economies, investments in statistical capacity yield meaningful SDG improvements.

3.  **Lower-Middle Income Countries** demonstrate an even stronger relationship (0.025) with high statistical significance (p = 0.0088). This is the most significant relationship among all income groups.

4.  **Low Income Countries** show the strongest coefficient (0.026), suggesting the largest potential impact, though with slightly lower statistical significance (p = 0.0459) than lower-middle income countries.

The R-squared values are relatively low across all models (between 0.004 and 0.023), indicating that changes in statistical capacity explain only a small portion of the variation in SDG changes. This is common in first-difference models and suggests that many other factors also influence SDG progress.

1.  The relationship between statistical capacity and sustainable development follows an inverted U-shaped pattern across the development spectrum - minimal impact for high-income countries, strongest for middle-income countries, and slightly less strong (but still significant) for low-income countries.

2.  Statistical capacity improvements appear most beneficial for developing and emerging economies, suggesting that international efforts to strengthen statistical systems should prioritize these countries.

3.  The consistently positive intercepts (ranging from 0.224 to 0.364) indicate that SDG scores tend to improve over time regardless of changes in statistical capacity, though the rate of improvement varies by income level.

 


## FD Visual Analysis: SDG ~ SPI + Income Groups 

**Error-bar**

```{r}
# Create dataframe for plotting 
plot_data <- fd_comparison %>%
  select(model, coefficient, p_value) %>%
  mutate(significant = p_value < 0.05)

# Create Horizontal error-bar graph 
fd_errorbar <- ggplot(plot_data, aes(x = coefficient, y = model, color = significant)) +
  geom_point(size = 3) +
  geom_errorbarh(aes(xmin = 0, xmax = coefficient), height = 0.2) + 
  geom_vline(xintercept = 0, linetype = "dashed") +
  scale_color_manual(values = c("gray", "blue")) +
  labs(title = "Effect of SPI Change on SDG Change by Income Group",
       x = "Coefficient (Effect Size)",
       y = "") +
  theme_bw() +
  theme(legend.position = "none")

fd_errorbar

#export fd_errorbar
# ggsave("fd_errorbar.png", width = 10, height = 6)
```

**Scatter plot of FDs**

```{r}
fd_scatter <- ggplot(fd_fe_data %>% 
         filter(!is.na(fd_sdg) & !is.na(fd_spi)), 
       aes(x = fd_spi, y = fd_sdg, color = income_level)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~income_level) +
  labs(title = "Relationship between Changes in SPI and SDG by Income Group",
       x = "Change in Statistical Performance (SPI)",
       y = "Change in Sustainable Development (SDG)") +
  theme_bw()

fd_scatter

#export fd_scatter
# ggsave("iCloud_Drive/Documents/GitHub/QMSS_Thesis_Sanchez", width = 10, height = 6)
```


