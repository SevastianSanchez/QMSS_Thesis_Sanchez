---
title: "Component 2: FE, FD, Granger Causality"
author: "Sevastian Sanchez"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  tidy = TRUE,
  tidy.opts = list(width.cutoff = 60)  # Adjust width as needed
)
```

#TEMPORAL MEDIATION ANALYSIS: First Difference, Fixed Effects, Lags, Checks

##setup: packages and data
```{r include=FALSE}
setwd("~/Documents/GitHub/QMSS_Thesis_Sanchez")

#load libraries 
source("packages.R")

#load data & function 
#source("data/data_sources.R")
#source("df_years2.0_Function.R")

#load df_years() function: 2015-present
#fd_fe_data <- df_years2.0(2004, 2023)

#read merged_df csv
fd_fe_data <- read_csv("data/Main CSV Outputs/merged_final_df.csv")

#selecting 
fd_fe_data <- fd_fe_data %>% 
  dplyr::select(country_code, year, year_fct, sdg_overall, spi_comp, di_score, aut_ep, dem_ep, income_level, income_level_lab, log_gdppc, population) %>% 
  arrange(country_code, year) %>%  # Critical for correct lagging
  filter(year >= 2016)
```

# TEST X: The effect of democracy score on SDG 
```{r}
#Total Effect: Check if regime type directly affects SDG scores (without SPI) + Controls & RobustSEs
total_sdg_di_ols <- lm(sdg_overall ~ di_score + log_gdppc + population + year_fct, data = fd_fe_data)
summary(total_sdg_di_ols)
coeftest(total_sdg_di_ols, vcov = vcovHC(total_sdg_di_ols, type = "HC1"))  

#plot relationship
plot_sdg_di <- ggplot(fd_fe_data, aes(x = di_score, y = sdg_overall)) + 
  geom_point(color = "#EE6A50", size = 1, alpha = 0.65) +
  geom_smooth(method = "lm", se = TRUE, color = "darkred", size = 1) +
  labs(
    title = "Effect of Democracy Score on SDG Status",
    x = "Democracy Score",
    y = "SDG Progress"
  ) +
  theme_minimal()

plot_sdg_di
```

# TEST 1: OLS Mediation analysis [REDO RESULTS FOR ROBUST SEs]
To test if SPI mediates the relationship between regime type and SDG outcomes:  
Democratic backsliding → reduces SPI → slows SDG progress  

*H0: SPI DOES NOT mediate (indirectly effect) the relationship between regime type and SDG status* 
*H1: SPI mediates (indirectly effects) the relationship between regime type and SDG status* 

- ACME (Average Causal Mediation Effect): SPI’s indirect effect.
- ADE (Average Direct Effect): Regime type’s direct effect, excluding SPI
```{r}
#seed to reproduce estimates 
set.seed(125)

#OLS Mediator model: Check if regime type affects SPI
med_spi_ols <- lm(spi_comp ~ di_score + log_gdppc + population + year_fct, data = fd_fe_data)
summary(med_spi_ols)
coeftest(med_spi_ols, vcov = vcovHC(med_spi_ols, type = "HC1")) #Robust SE

#OLS Outcome model: Check if SPI affects SDG scores while controlling for regime type
output_sdg_ols <- lm(sdg_overall ~ spi_comp + di_score + log_gdppc + population + year_fct, data = fd_fe_data)
summary(output_sdg_ols)
coeftest(output_sdg_ols, vcov = vcovHC(output_sdg_ols, type = "HC1")) #Robust SE

#OLS Mediation test: Quantify how much of regime type’s effect on SDGs operates through SPI
med_model <- mediate(med_spi_ols, output_sdg_ols, 
                     treat = "di_score", 
                     mediator = "spi_comp", 
                     sims = 1000, 
                     robustSE = TRUE)
summary(med_model)

#Sensitivity Analysis: Tests how robust mediation findings are to potential unmeasured confounding variables
#sens_med <- medsens(med_model, rho.by = 0.1)
#summary(sens_med)
#plot(sens_med)
```
*[UPDATE RESULTS - OMITTED GINI VAR]*
ACEM: SPI’s indirect effect = 0.62884 units (p < 0.001)
ADE: Regime type’s direct effect, excluding SPI = 0.00565 (p = 0.008) ??? units
Total Effect: = 0.63449 units (p = 0.008)
Proportion Mediated: = 0.98081 or 98.08% ?? of total units

`Proportion Mediated` = the percent difference between the total effect (SDG ~ DI) and indirect ACEM effect (+ SPI)

Interpretation: A 1-unit DI increase boosts SDG scores by 0.63449 total units, with 0.62884 units (98.08% of units) transmitted through SPI. The remaining 0.00565 units represents democracy score's effect (e.g., governance reforms unrelated to statistics) on SDG progress. 

Because the indirect effect of SPI on sdg_overall (ACME) is highly significant (p < 0.001), there is evidence to suggest that SPI mediates the regime-SDG relationship, based on the model. 

Because the ADE (the direct effect between di_score on sdg_overall) is not significant, SPI DOES ENTIRELY explain the connection between regime type and sdg status, based on the model. 
--------------------------------------------------------------------------

# **Panel Data Analysis**

**First Difference (FD)** removes all time-invariant characteristics of each unit (like geography, culture, or baseline wealth). However, variables that do change over time, such as GDP per capita and country population, should be controlled.

**Fixed Effects (FE)** [description...]

## TEST X, First Difference: SPI ~ DI & SDG ~ SPI 
```{r}
# panel dataframe
panel_data <- pdata.frame(
  fd_fe_data, 
  index = c("country_code", "year")  # Replace 'year' with your time variable
)

###### SPI ~ DI ######
fd_spi_di <- plm(
  spi_comp ~ di_score + log_gdppc + population,
  data = panel_data,
  model = "fd" #FD
)
#summary(fd_spi_di)
# Country-level custard Robust SEs
coeftest(fd_spi_di, vcov = vcovHC(fd_spi_di, cluster = "group", type = "HC1"))

###### SDG ~ SPI ######
fd_sdg_spi <- plm(
  sdg_overall ~ spi_comp + di_score + log_gdppc + population,
  data = panel_data,
  model = "fd" #FD
)
#summary(fd_sdg_spi)
# Country-level custard Robust SEs
coeftest(fd_sdg_spi, vcov = vcovHC(fd_sdg_spi, cluster = "group", type = "HC1"))
```
Results: 

FD Models: 
SPI ~ DI: -0.9927 (p = 0.0083**)
SDG ~ SPI: 0.0158 (p = 0.0032**)

## TEST X, Fixed Effects Models: SPI ~ DI & SDG ~ SPI  
```{r}
###### SPI ~ DI ######
fe_spi_di <- plm(
  spi_comp ~ di_score + log_gdppc + population + factor(year),
  data = panel_data,
  model = "within" #FE
)

summary(fe_spi_di)
coeftest(fe_spi_di, vcov = vcovHC(fe_spi_di, cluster = "group", type = "HC1")) # Robust SEs

##### SDG ~ SPI #####
fe_sdg_spi <- plm(
  sdg_overall ~ spi_comp + di_score + log_gdppc + population + factor(year),
  data = panel_data,
  model = "within" #FE
)

summary(fe_sdg_spi)
coeftest(fe_sdg_spi, vcov = vcovHC(fe_sdg_spi, cluster = "group", type = "HC1"))  # Robust SEs
```
Results:

SPI ~ DI: -0.4976 (p = 0.3886) [not significant]
  year_fct: 2.0536 (p < 2e-16***)
SDG ~ SPI: 0.0324 (p = 0.1247) [not significant]
  year_fct: 2.5292e-01 (p < 2.2e-16***)

Neither SPI~DI or SDG~SPI models are statistically significant. This contrasts from previous first difference estimates that found both SPI~DI and SDG~SPI models statistically significant (p < 0.05). Interestingly, the factored-year variable (year_fct) in both FE models are extremely statistically significant with increasing coefficient estimates over the years. This suggests underlying trends that statistical capacity is, on average, increasing based on the model. 

## TEST X: Granger Causality: DI & SPI
Essentially tests whether a predictor variable in a prior year has an affect on a present day dependent variable. In this case, my study utilizes a granger test to both understand directionality of effects, assessing potential reverse causality of x and y variables, and determine the need to incorporate lagged predictors (DI and SPI variables).
```{r}
# SPI ~ DI [SIGNIFICANT]
grangertest(spi_comp ~ di_score, order = 1, data = panel_data) # Most optimal 
grangertest(spi_comp ~ di_score, order = 2, data = panel_data)

# DI ~ SPI [NOT]
grangertest(di_score ~ spi_comp, order = 1, data = panel_data)
grangertest(di_score ~ spi_comp, order = 2, data = panel_data)
```

spi_comp ~ di_score[order=1]: F = 16.97, p = 4.048e-05 (***)
- As speculated/hypothesized, democracy scores (di_score) DO help predict current SPI scores. 
- Although we recieve statistically significant results upon increasing the lag order, the F statistic drops sharply from 16.97 to 8.8021 and then continues falling gradually, as p-value increases ever so slightly (although still extremely below alpha 0.05). Accordingly, 1st orderd lagged di_score predictors are optimal and sufficient for the following Fixed Effects models. 

di_score ~ spi_comp[order=1]: F = 0.4086, p = 0.5228
- As expected, past SPI scores do NOT help predict current democracy scores (di_score)
- even incorporating more lags, the relationships remain not statistically significant 

**Bottom Line**
Changes in regime characteristics precede changes in statistical capacity, NOT vice versa

## TEST X: Granger Causality: SPI & SDG
```{r}
# SDG ~ SPI [SIGNIFICANT?]
grangertest(sdg_overall ~ spi_comp, order = 1, data = panel_data)
grangertest(sdg_overall ~ spi_comp, order = 2, data = panel_data)

# SPI ~ SDG [NOT?]
grangertest(spi_comp ~ sdg_overall, order = 1, data = panel_data) # most optimal 
grangertest(spi_comp ~ sdg_overall, order = 2, data = panel_data)
```
Results:

SDG~SPI [order = 1]: F = 2.5447, p = 0.1109

SPI~SDG [order = 1]: F = 8.7453, p = 0.00316 (**)

Unexpectedly, the results of the granger causality tests showed that it is SDG status that preceeds changes in statistical capacity, similar to DI score. It is possible that certain SDG goals/indicators could predict statistical capacity, such as SDG 17 (strong institutions) and/or SDG 4 (Quality Education) that could facilitate the growth of national statistical capacity. Deeper analysis of separate SDG score (disaggregated by individual score 1-17) impacts on predictor variables (in a similar methodological scheme) would provide interesting insights into this 'chicken or the egg' problem on a deeper level. This study reconsiders strategy due to suprising, but valid, evidence of reverse causality.  

## Assessing Autocorrelation 
ACF checks for independence of errors in regression analysis. This assesses whether x variables are correlated across time to determine correlation at different lags (autocorrelation).

### ACF Function
```{r}
acf(resid(fd_spi_di), lag.max = 10)
acf(resid(fd_sdg_spi), lag.max = 10)
acf(resid(fe_spi_di), lag.max = 10)
acf(resid(fe_sdg_spi), lag.max = 10)
```

# Temporal Dependent Lags
Considering results from the granger test, there is evidence that democracy score changes preceed changes in SPI (first). This is in line with studies that sustain it can take some time for implementation of statistical capacity structures to produce results.

Similarly, I suspect that regime transition has a delayed effect on statistical capacity, although I suspect it varies in time (do we notice a drop in SPI as a precondition or a symptom of autocratization)?

## Significant Autocorrelation: create lagged variables and first differences [MAY NOT NEED]

```{r eval=FALSE, include=FALSE}
# Create lagged variables and first differences
panel_data <- panel_data %>%
  arrange(country_code, year) %>% 
  group_by(country_code) %>%
  mutate(
    # 1 year lags
    sdg_lag_1 = dplyr::lag(sdg_overall, n = 1),
    spi_lag_1 = dplyr::lag(spi_comp, n = 1),
    di_lag_1 = dplyr::lag(di_score, n = 1),
    # 2-year lags 
    sdg_lag_2 = dplyr::lag(sdg_overall, n = 2),
    spi_lag_2 = dplyr::lag(spi_comp, n = 2),
    di_lag_2 = dplyr::lag(di_score, n = 2),
    
    # Calculate first differences
    fd_sdg_1 = sdg_overall - sdg_lag_1,
    fd_spi_1 = spi_comp - spi_lag_1,
    fd_di_1 = di_score - di_lag_1,
    fd_sdg_2 = sdg_overall - sdg_lag_2,
    fd_spi_2 = spi_comp - spi_lag_2,
    fd_di_2 = di_score - di_lag_2
  ) %>%
  ungroup()

# To verify the lag creation works correctly
#head(fd_data_testing %>% dplyr::select(country_code, year, sdg_overall, sdg_lag, fd_sdg, spi_comp, spi_lag, fd_spi) %>% arrange(country_code, year), 10)
```



## TEST X, First Difference + LAGS: SPI ~ DI & SDG ~ SPI [R STUDIO CRASHES HERE-BEYOND THIS POINT]
```{r eval=FALSE, include=FALSE}
#First Difference 
fd_spi_di_lag <- plm(
  spi_comp ~ lag(di_score, 1) + log_gdppc + population,
  data = panel_data,
  index = c("country_code", "year"),
  model = "fd" #FD
)

summary(fd_spi_di_lag)
coeftest(fd_spi_di_lag, vcov = vcovHC(fd_spi_di_lag, cluster = "group")) # Robust SEs

# First Difference 
fd_sdg_spi_lag <- plm(
  sdg_overall ~ lag(spi_comp, 1) + di_score + log_gdppc + population,
  data = panel_data,
  index = c("country_code", "year"),
  model = "fd" #FD
)

summary(fd_sdg_spi_lag)
coeftest(fd_sdg_spi_lag, vcov = vcovHC(fd_sdg_spi_lag, cluster = "group")) # Robust SEs
```

## TEST X, Fixed Effects + LAGS: SPI ~ DI & SDG ~ SPI
```{r eval=FALSE, include=FALSE}
# Fixed Effects 
fe_spi_di_lag <- plm(
  spi_comp ~ plm::lag(di_score) + log_gdppc + population + year_fct,
  data = panel_data,
  index = c("country_code", "year"),
  model = "within" #FE
)

summary(fe_spi_di_lag)
coeftest(fe_spi_di_lag, vcov = vcovHC(fe_spi_di_lag, cluster = "group")) # Robust SEs

# Fixed Effects 
fe_sdg_spi_lag <- plm(
  sdg_overall ~ plm::lag(spi_comp) + di_score + log_gdppc + population + year_fct,
  data = panel_data,
  index = c("country_code", "year"),
  model = "within" #FE
)

summary(fe_sdg_spi_lag)
coeftest(fe_sdg_spi_lag, vcov = vcovHC(fe_sdg_spi_lag, cluster = "group")) # Robust SEs
```

## ROBUSTNESS CHECKS 

### AIC/BIC
```{r eval=FALSE, include=FALSE}
fe_lag1 <- plm(spi_comp ~ lag(di_score, 1), data = panel_data, model = "within")
fe_lag2 <- plm(spi_comp ~ lag(di_score, 1) + lag(di_score, 2), data = panel_data, model = "within")
AIC(fe_lag1, fe_lag2)

```


### Breusch-Godfrey Autocorrelation Tests: AR(1) + AR(2)
```{r}
#mediator models 
pbgtest(fe_spi_di, order = 1) # AR(1)
pbgtest(fe_spi_di, order = 2) # AR(2)
```
This analysis does not test for autocorrelation by using the Durban Watson approach because the approach is designed for single time series, not panel models. Instead, this study adopts the Breusch-Godfrey (BG) approach to detect *high order* autocorrelation in addition to other forms. 

## Mediation Effect: connecting Regime -> SDGs 
Mediation analysis to formally test and quantify SPI's role in transmitting regime change effects to SDGs. This is how to quantify the connection between the Regime Change and the SDGs

## Mediation Effect + Lags: connecting DI -> SDGs
```{r eval=FALSE, include=FALSE}
## CONFIRM THE MED MODELS BELOW ARE OKAY W PERPLEXITY 

# Mediation analysis - FD models 
med_fd_lag_results <- mediate(
  fd_spi_di_lag, # mediator model
  fd_sdg_spi_lag, # outcome model 
  treat = "di_score",   # Treatment variable (regime change)
  mediator = "spi_comp", # SPI mediator
  sims = 1000,        # Number of bootstrap simulations
  robustSE = TRUE     # Cluster SEs by country
)

summary(med_fd_lag_results)

# After running mediation
sens_med <- medsens(med_fd_lag_results, rho.by = 0.1)
plot(sens_med)

# Mediation analysis - FE models 
med_fe_lag_results <- mediate(
  fe_spi_di_lag, # mediator model
  fe_sdg_spi_lag, # outcome model 
  treat = "di_score",   # Treatment variable (regime change)
  mediator = "spi_comp", # SPI mediator
  sims = 1000,        # Number of bootstrap simulations
  robustSE = TRUE     # Cluster SEs by country
)

summary(med_fe_lag_results)

# After running mediation
sens_med <- medsens(med_fe_lag_results, rho.by = 0.1)
plot(sens_med)
```

## FD Mediation (including lags) [MAY NOT NEED]
```{r eval=FALSE, include=FALSE}

####### Mediation analysis - FD models ####### 
#seed 
set.seed(124)

med_fd_results <- mediate(
  fd_spi_di, # mediator model
  fd_sdg_spi, # outcome model 
  treat = "di_score",   # Treatment variable (regime change)
  mediator = "spi_comp", # SPI mediator
  robustSE = TRUE
)

summary(med_fd_results)

# Sensitivity Analysis: after running mediation
sens_med_fd <- medsens(med_fd_results, rho.by = 0.1)
plot(sens_med_fd)
```

## FE Mediation (including lags) [MAY NOT NEED]
```{r eval=FALSE, include=FALSE}

####### Mediation analysis - FE models ####### 
#seed
set.seed(124)

med_fe_results <- mediate(
  fe_spi_di, # mediator model
  fe_sdg_spi, # outcome model 
  treat = "di_score",   # Treatment variable (regime change)
  mediator = "spi_comp", # SPI mediator
  robustSE = TRUE
)

summary(med_fe_results)

# Sensitivity Analysis: after running mediation
sens_med_fe <- medsens(med_fe_results, rho.by = 0.1)
plot(sens_med_fe)
```
